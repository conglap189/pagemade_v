{% extends "base.html" %}
{% block title %}Dashboard - PageMade.site{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar">
            <div class="sticky-top">
                <h6 class="text-muted text-uppercase px-3 mb-3">Menu</h6>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="{{ url_for('main.dashboard') }}">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </a>
                    <a class="nav-link" href="{{ url_for('main.new_site') }}">
                        <i class="fas fa-plus"></i> Tạo Site Mới
                    </a>
                    <hr>
                    <h6 class="text-muted text-uppercase px-3 mb-2">Sites của bạn</h6>
                    {% for item in sites_with_pages %}
                        <a class="nav-link" href="{{ url_for('main.site_detail', site_id=item.site.id) }}">
                            <i class="fas fa-globe"></i> {{ item.site.title }}
                            <span class="badge bg-secondary ms-auto">{{ item.pages|length }}</span>
                        </a>
                    {% endfor %}
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 content-area">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Dashboard</h2>
                    <p class="text-muted">Chào mừng trở lại, {{ current_user.name }}!</p>
                </div>
                <a href="{{ url_for('main.new_site') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Tạo Site Mới
                </a>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5>Total Sites</h5>
                                    <h3>{{ sites_with_pages|length }}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-globe fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5>Total Pages</h5>
                                    <h3>{% set total_pages = 0 %}{% for site in sites_with_pages %}{% set total_pages = total_pages + site.pages|length %}{% endfor %}{{ total_pages }}</h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-file-alt fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5>Published</h5>
                                    <h3>
                                        {%- set published_count = 0 -%}
                                        {%- for item in sites_with_pages -%}
                                            {%- for page in item.pages -%}
                                                {%- if page.is_published -%}
                                                    {%- set published_count = published_count + 1 -%}
                                                {%- endif -%}
                                            {%- endfor -%}
                                        {%- endfor -%}
                                        {{ published_count }}
                                    </h3>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sites Grid -->
            {% if sites_with_pages %}
                <div class="row">
                    {% for item in sites_with_pages %}
                    <div class="col-lg-6 mb-4">
                        <div class="card site-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">{{ item.site.title }}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('main.site_detail', site_id=item.site.id) }}"><i class="fas fa-eye"></i> Xem chi tiết</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('main.new_page', site_id=item.site.id) }}"><i class="fas fa-plus"></i> Thêm page</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteSite({{ item.site.id }})"><i class="fas fa-trash"></i> Xóa site</a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <p class="card-text text-muted">{{ item.site.description or 'Chưa có mô tả' }}</p>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-link"></i> {{ item.site.subdomain }}.pagemade.site
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-calendar"></i> {{ item.site.created_at.strftime('%d/%m/%Y') }}
                                    </small>
                                </div>
                                
                                <!-- Pages in this site -->
                                {% if item.pages %}
                                    <h6>Pages ({{ item.pages|length }}):</h6>
                                    <div class="row">
                                        {% for page in item.pages %}
                                        <div class="col-md-6 mb-2">
                                            <div class="page-card p-2">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <small class="fw-bold">{{ page.title }}</small>
                                                        {% if page.is_published %}
                                                            <span class="published-badge">Published</span>
                                                        {% else %}
                                                            <span class="draft-badge">Draft</span>
                                                        {% endif %}
                                                    </div>
                                                    <div class="btn-group btn-group-sm" role="group">
                                                        <a href="{{ url_for('main.editor', page_id=page.id) }}" class="btn btn-outline-primary btn-sm">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                        {% if page.is_published %}
                                                            <a href="{{ url_for('main.view_page', subdomain=page.site.subdomain, page_id=page.id) }}" class="btn btn-outline-success btn-sm" target="_blank">
                                                                <i class="fas fa-external-link-alt"></i>
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted"><i>Chưa có page nào</i></p>
                                {% endif %}
                                
                                <div class="mt-3">
                                    <a href="{{ url_for('main.site_detail', site_id=item.site.id) }}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-arrow-right"></i> Quản lý site
                                    </a>
                                    <a href="{{ url_for('main.new_page', site_id=item.site.id) }}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-plus"></i> Thêm page
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="text-center py-5">
                    <i class="fas fa-globe fa-5x text-muted mb-4"></i>
                    <h4>Chưa có site nào</h4>
                    <p class="text-muted mb-4">Tạo site đầu tiên của bạn để bắt đầu xây dựng landing page tuyệt vời</p>
                    <a href="{{ url_for('main.new_site') }}" class="btn btn-primary btn-lg">
                        <i class="fas fa-plus"></i> Tạo Site Đầu Tiên
                    </a>
                </div>
            {% endif %}

            <!-- Quick Actions -->
            {% if current_user.email == 'admin@autolandingpage.com' %}
            <div class="mt-5">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-tools"></i> Admin Tools</h6>
                    </div>
                    <div class="card-body">
                        <a href="{{ url_for('main.reset_demo') }}" class="btn btn-outline-warning btn-sm" onclick="return confirm('Bạn có chắc muốn reset tất cả demo data?')">
                            <i class="fas fa-refresh"></i> Reset Demo Data
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function deleteSite(siteId) {
    if (confirm('Bạn có chắc muốn xóa site này? Tất cả pages trong site cũng sẽ bị xóa.')) {
        fetch(`/api/sites/${siteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                location.reload();
            } else {
                alert('Có lỗi xảy ra khi xóa site');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra khi xóa site');
        });
    }
}
</script>
{% endblock %}