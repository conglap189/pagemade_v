{% extends "base.html" %}

{% block title %}{{ site.title }} - PageMade{% endblock %}

{% block content %}
<div class="min-h-screen">
  <!-- Main Content -->
  <main class="p-4 mx-auto max-w-(--breakpoint-2xl) md:p-6">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center space-x-4 mb-4 sm:mb-0">
          <a href="{{ url_for('sites.dashboard') }}" 
             class="inline-flex items-center px-3 py-2 text-slate-600 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Quay lại
          </a>
          <div class="h-6 w-px bg-slate-300 dark:bg-slate-600"></div>
          <div class="flex items-center space-x-3">
            <div class="w-12 h-12 bg-slate-100 dark:bg-slate-700 rounded-xl flex items-center justify-center">
              <span class="text-slate-600 dark:text-slate-300 text-lg font-bold">{{ site.title[0].upper() }}</span>
            </div>
            <div>
              <h1 class="text-2xl font-bold text-slate-800 dark:text-white">{{ site.title }}</h1>
              <p class="text-slate-600 dark:text-slate-400 text-sm">{{ site.pages|length }} trang</p>
            </div>
          </div>
        </div>
        
        <div class="flex items-center space-x-3">
          <a href="{{ url_for('pages.new_page', site_id=site.id) }}" 
             class="inline-flex items-center gap-2 rounded-lg bg-emerald-500 px-4 py-3 text-sm font-medium text-white shadow-theme-xs transition hover:bg-emerald-600">
            <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M10 3C10.5523 3 11 3.44772 11 4V9H16C16.5523 9 17 9.44772 17 10C17 10.5523 16.5523 11 16 11H11V16C11 16.5523 10.5523 17 10 17C9.44772 17 9 16.5523 9 16V11H4C3.44772 11 3 10.5523 3 10C3 9.44772 3.44772 9 4 9H9V4C9 3.44772 9.44772 3 10 3Z" fill="currentColor"/>
            </svg>
            Trang mới
          </a>
          <button onclick="deleteSite()" 
                  class="inline-flex items-center gap-2 rounded-lg bg-red-500 px-4 py-3 text-sm font-medium text-white shadow-theme-xs transition hover:bg-red-600">
            <i class="fas fa-trash w-4"></i>
            Xóa site
          </button>
        </div>
      </div>
      
      <!-- Site Info -->
      <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        {% if site.subdomain %}
          <div class="flex items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
            <i class="fas fa-link text-gray-500 mr-3"></i>
            <div>
              <p class="text-sm text-slate-600 dark:text-slate-400">URL</p>
              <a href="http://{{ site.subdomain }}.pagemade.site" target="_blank" 
                 class="text-blue-600 dark:text-blue-400 hover:underline font-medium">
                {{ site.subdomain }}.pagemade.site
              </a>
            </div>
          </div>
        {% endif %}
        
        <div class="flex items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
          <i class="fas fa-calendar text-gray-500 mr-3"></i>
          <div>
            <p class="text-sm text-slate-600 dark:text-slate-400">Ngày tạo</p>
            <p class="text-slate-800 dark:text-slate-200 font-medium">{{ site.created_at.strftime('%d/%m/%Y') }}</p>
          </div>
        </div>
        
        <div class="flex items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-lg">
          <i class="fas fa-file-alt text-gray-500 mr-3"></i>
          <div>
            <p class="text-sm text-slate-600 dark:text-slate-400">Tổng trang</p>
            <p class="text-slate-800 dark:text-slate-200 font-medium">{{ site.pages|length }}</p>
          </div>
        </div>
      </div>
    </div>

    {% if site.description %}
      <!-- Description Card -->
      <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-6 mb-8">
        <div class="flex items-start space-x-4">
          <div class="flex-shrink-0">
            <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
              <i class="fas fa-info-circle text-white"></i>
            </div>
          </div>
          <div>
            <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-1">Mô tả</h3>
            <p class="text-sm text-blue-800 dark:text-blue-200">{{ site.description }}</p>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
      <div class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Tổng</p>
            <p class="text-title-sm font-bold text-gray-800 dark:text-white/90 mb-1">{{ site.pages|length }}</p>
            <p class="text-theme-xs text-gray-500 dark:text-gray-400">Trang</p>
          </div>
          <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-blue-100 dark:bg-blue-900/30">
            <i class="fas fa-file-alt text-blue-600 dark:text-blue-400 text-xl"></i>
          </div>
        </div>

      </div>

      <div class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Đã xuất bản</p>
            <p class="text-title-sm font-bold text-gray-800 dark:text-white/90 mb-1">
              {{ site.pages|selectattr('is_published')|list|length }}
            </p>
            <p class="text-theme-xs text-gray-500 dark:text-gray-400">Trang đang hoạt động</p>
          </div>
          <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-green-100 dark:bg-green-900/30">
            <i class="fas fa-check-circle text-green-600 dark:text-green-400 text-xl"></i>
          </div>
        </div>

      </div>

      <div class="rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-gray-500 dark:text-gray-400 font-medium mb-1">Bản nháp</p>
            <p class="text-title-sm font-bold text-gray-800 dark:text-white/90 mb-1">
              {{ site.pages|rejectattr('is_published')|list|length }}
            </p>
            <p class="text-theme-xs text-gray-500 dark:text-gray-400">Chưa xuất bản</p>
          </div>
          <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-yellow-100 dark:bg-yellow-900/30">
            <i class="fas fa-edit text-yellow-600 dark:text-yellow-400 text-xl"></i>
          </div>
        </div>

      </div>
    </div>

    <!-- Pages Grid -->
    <div class="rounded-2xl border border-gray-200 bg-white dark:border-gray-800 dark:bg-white/[0.03] overflow-hidden">
      <div class="px-6 py-6 border-b border-gray-200 dark:border-gray-800">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-title-sm font-bold text-gray-800 dark:text-white/90">Trang của bạn</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-1 text-theme-sm">Quản lý và tổ chức các trang của bạn</p>
          </div>
          <div class="flex items-center space-x-3">
            <button class="p-2 text-gray-600 dark:text-gray-400 hover:text-brand-600 dark:hover:text-brand-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
              <i class="fas fa-search"></i>
            </button>
            <button class="p-2 text-gray-600 dark:text-gray-400 hover:text-brand-600 dark:hover:text-brand-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-lg transition-colors">
              <i class="fas fa-filter"></i>
            </button>
            <a href="{{ url_for('pages.new_page', site_id=site.id) }}" 
               class="inline-flex items-center gap-2 px-5 py-3.5 text-sm font-medium text-white transition rounded-lg bg-emerald-500 shadow-theme-xs hover:bg-emerald-600">
              <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10 3C10.5523 3 11 3.44772 11 4V9H16C16.5523 9 17 9.44772 17 10C17 10.5523 16.5523 11 16 11H11V16C11 16.5523 10.5523 17 10 17C9.44772 17 9 16.5523 9 16V11H4C3.44772 11 3 10.5523 3 10C3 9.44772 3.44772 9 4 9H9V4C9 3.44772 9.44772 3 10 3Z" fill="currentColor"/>
              </svg>
              Thêm trang
            </a>
          </div>
        </div>
      </div>
      
      <div class="p-6">

        {% if site.pages %}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            {% for page in site.pages %}
              <div class="group relative rounded-2xl border border-gray-200 bg-white p-5 dark:border-gray-800 dark:bg-white/[0.03] md:p-6 hover:shadow-lg transition-all duration-300"
                   x-data="{ open: false }">
                
                <!-- Page Header -->
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1 min-w-0">
                    <h3 class="font-bold text-slate-800 dark:text-white mb-1 truncate">{{ page.title }}</h3>
                    {% if page.is_published %}
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                        <i class="fas fa-check-circle mr-1"></i> Đã xuất bản
                      </span>
                    {% else %}
                      <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400">
                        <i class="fas fa-edit mr-1"></i> Bản nháp
                      </span>
                    {% endif %}
                  </div>
                  
                  <!-- Dropdown Menu -->
                  <div class="relative ml-2">
                    <button @click="open = !open" class="p-2 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-colors">
                      <i class="fas fa-ellipsis-v text-slate-600 dark:text-slate-300"></i>
                    </button>
                    
                     <div x-show="open" 
                          x-transition:enter="transition ease-out duration-200"
                          x-transition:enter-start="opacity-0 scale-95"
                          x-transition:enter-end="opacity-100 scale-100"
                          x-transition:leave="transition ease-in duration-150"
                          x-transition:leave-start="opacity-100 scale-100"
                          x-transition:leave-end="opacity-0 scale-95"
                          @click.away="open = false"
                          class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-200 dark:border-gray-700 z-10">
                       <a href="{{ url_for('pages.editor', page_id=page.id) }}" 
                          class="flex items-center space-x-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-xl transition-colors">
                         <i class="fas fa-eye w-4"></i>
                         <span>View Details</span>
                       </a>
                      {% if page.is_published %}
                         <a href="{{ url_for('pages.view_page', subdomain=site.subdomain, page_id=page.id) }}" 
                            target="_blank"
                            class="flex items-center space-x-3 px-4 py-3 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                           <i class="fas fa-external-link-alt w-4"></i>
                           <span>Xem trực tiếp</span>
                         </a>
                      {% endif %}
                      <div class="border-t border-gray-200 dark:border-gray-700"></div>
                      <button data-page-id="{{ page.id }}" 
                              class="delete-page-btn w-full flex items-center space-x-3 px-4 py-3 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-b-xl transition-colors">
                        <i class="fas fa-trash w-4"></i>
                        <span>Xóa</span>
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Page Description -->
                {% if page.description %}
                  <p class="text-sm text-slate-600 dark:text-slate-400 mb-4 line-clamp-2">{{ page.description }}</p>
                {% endif %}

                <!-- Page Meta -->
                <div class="space-y-2 mb-4 text-xs text-slate-500 dark:text-slate-400">
                  <div class="flex items-center">
                    <i class="fas fa-layer-group w-4 mr-2 text-gray-500"></i>
                    <span>Template: {{ page.template|title }}</span>
                  </div>
                  <div class="flex items-center">
                    <i class="fas fa-clock w-4 mr-2 text-gray-500"></i>
                    <span>Cập nhật {{ page.updated_at.strftime('%d/%m/%Y') }}</span>
                  </div>
                  {% if page.is_published %}
                  <div class="flex items-center">
                    <i class="fas fa-external-link-alt w-4 mr-2 text-gray-500"></i>
                    <span>URL: <a href="{{ page.get_url() }}" target="_blank" class="text-blue-600 hover:text-blue-800 hover:underline">{{ page.get_url() }}</a></span>
                  </div>
                  {% endif %}
                </div>

                  <!-- Actions -->
                  <div class="flex space-x-3">
                    <a href="{{ get_editor_url() }}/editor/{{ page.id }}?token={{ generate_editor_token(page.id) }}" 
                       class="inline-flex items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-blue-600 transition hover:bg-blue-50 flex-1 justify-center">
                     <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                       <path fill-rule="evenodd" clip-rule="evenodd" d="M13.5858 3.58579C14.3668 2.80474 15.6332 2.80474 16.4142 3.58579C17.1953 4.36683 17.1953 5.63316 16.4142 6.41421L15.6213 7.20711L12.7929 4.37868L13.5858 3.58579ZM11.3787 5.79289L3 14.1716V17H5.82842L14.2071 8.62132L11.3787 5.79289Z" fill="currentColor"/>
                     </svg>
                     Chỉnh sửa
                    </a>
                       {% if page.is_published %}
                         <a href="{{ url_for('pages.view_page', subdomain=site.subdomain, page_id=page.id) }}" 
                            target="_blank"
                            class="inline-flex items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-emerald-600 dark:text-emerald-400 transition hover:bg-emerald-50 dark:hover:bg-emerald-900/20"
                            title="Xem trực tiếp">
                           <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                             <path fill-rule="evenodd" clip-rule="evenodd" d="M10 12C11.1046 12 12 11.1046 12 10C12 8.89543 11.1046 8 10 8C8.89543 8 8 8.89543 8 10C8 11.1046 8.89543 12 10 12ZM10 14C12.2091 14 14 12.2091 14 10C14 7.79086 12.2091 6 10 6C7.79086 6 6 7.79086 6 10C6 12.2091 7.79086 14 10 14ZM10 16C13.3137 16 16 13.3137 16 10C16 6.68629 13.3137 4 10 4C6.68629 4 4 6.68629 4 10C4 13.3137 6.68629 16 10 16Z" fill="currentColor"/>
                           </svg>
                         </a>
                       {% else %}
                         <button data-page-id="{{ page.id }}" 
                                 class="publish-page-btn group inline-flex items-center gap-2 rounded-lg px-4 py-3 text-sm font-medium text-amber-600 dark:text-amber-400 transition hover:bg-amber-50 dark:hover:bg-amber-900/20"
                                 title="Xuất bản">
                           <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                             <path fill-rule="evenodd" clip-rule="evenodd" d="M3 17C3 16.4477 3.44772 16,4 16H16C16.5523 16,17 16.4477 17 17C17 17.5523 16.5523 18,16 18H4C3.44772 18 3,17.5523 3 17ZM6.29289 6.70711C5.90237 6.31658 5.90237 5.68342 6.29289 5.29289L9.29289 2.29289C9.68342 1.90237 10.3166 1.90237 10.7071 2.29289L13.7071 5.29289C14.0976 5.68342 14.0976 6.31658 13.7071 6.70711C13.3166 7.09763 12.6834 7.09763 12.2929 6.70711L11 5.41421V12C11 12.5523 10.5523 13,10 13C9.44772 13 9,12.5523 9 12V5.41421L7.70711 6.70711C7.31658 7.09763 6.68342 7.09763 6.29289 6.70711Z" fill="currentColor"/>
                           </svg>
                         </button>
                       {% endif %}
                 </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <!-- Empty State -->
          <div class="text-center py-16">
            <div class="inline-flex items-center justify-center w-24 h-24 bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/20 dark:to-purple-900/20 rounded-full mb-6">
              <i class="fas fa-file-alt text-5xl text-blue-500 dark:text-blue-400"></i>
            </div>
            <h3 class="text-2xl font-bold text-slate-700 dark:text-slate-300 mb-2">Chưa có trang nào</h3>
            <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-md mx-auto">
              Tạo trang đầu tiên để bắt đầu xây dựng nội dung cho website của bạn.
            </p>
            <a href="{{ url_for('pages.new_page', site_id=site.id) }}" 
               class="inline-flex items-center gap-3 px-8 py-4 text-lg font-medium text-white transition rounded-lg bg-emerald-500 shadow-theme-xs hover:bg-emerald-600">
              <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M10 3C10.5523 3 11 3.44772 11 4V9H16C16.5523 9 17 9.44772 17 10C17 10.5523 16.5523 11 16 11H11V16C11 16.5523 10.5523 17 10 17C9.44772 17 9 16.5523 9 16V11H4C3.44772 11 3 10.5523 3 10C3 9.44772 3.44772 9 4 9H9V4C9 3.44772 9.44772 3 10 3Z" fill="currentColor"/>
              </svg>
              Tạo trang đầu tiên
            </a>
          </div>
        {% endif %}
      </div>
    </div>
  </main>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Publish page functionality
  document.querySelectorAll('.publish-page-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const pageId = this.getAttribute('data-page-id');
      if (confirm('Xuất bản trang này?')) {
        fetch(`/page/${pageId}/publish`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.message || 'Không thể xuất bản trang');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Có lỗi xảy ra');
        });
      }
    });
  });

  // Delete page functionality
  document.querySelectorAll('.delete-page-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const pageId = this.getAttribute('data-page-id');
      if (confirm('Bạn có chắc chắn muốn xóa trang này? Hành động này không thể hoàn tác.')) {
        fetch(`/page/${pageId}/delete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.reload();
          } else {
            alert(data.message || 'Không thể xóa trang');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Có lỗi xảy ra');
        });
      }
    });
  });
});

function deleteSite() {
  if (confirm('Bạn có chắc chắn muốn xóa toàn bộ site này? Điều này sẽ xóa tất cả các trang và không thể hoàn tác.')) {
    fetch(`/site/{{ site.id }}/delete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        window.location.href = '{{ url_for("sites.dashboard") }}';
      } else {
        alert(data.message || 'Không thể xóa site');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra');
    });
  }
}
</script>
{% endblock %}
