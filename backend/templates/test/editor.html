{% extends "base.html" %}

{% block title %}Editor - {{ page.title }}{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        height: calc(100vh - 76px);
    }
    
    .editor-sidebar {
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        height: 100%;
        overflow-y: auto;
    }
    
    .editor-content {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    
    .editor-toolbar {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 10px 15px;
        flex-shrink: 0;
    }
    
    .editor-canvas {
        flex: 1;
        overflow: auto;
        background: #f8f9fa;
        padding: 20px;
    }
    
    .page-canvas {
        background: white;
        min-height: 500px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
        margin: 0 auto;
        max-width: 1200px;
        padding: 20px;
    }
    
    .component-item {
        padding: 10px;
        margin: 5px 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .component-item:hover {
        border-color: var(--bs-primary);
        background: #f8f9fa;
    }
    
    .editable-element {
        position: relative;
        min-height: 20px;
        padding: 10px;
        border: 2px dashed transparent;
        transition: all 0.3s ease;
    }
    
    .editable-element:hover {
        border-color: var(--bs-primary);
        background: rgba(13, 110, 253, 0.1);
    }
    
    .editable-element.selected {
        border-color: var(--bs-success);
        background: rgba(25, 135, 84, 0.1);
    }
    
    .element-toolbar {
        position: absolute;
        top: -30px;
        right: 0;
        background: var(--bs-dark);
        border-radius: 3px;
        padding: 2px;
        display: none;
    }
    
    .editable-element:hover .element-toolbar,
    .editable-element.selected .element-toolbar {
        display: block;
    }
    
    .properties-panel {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-top: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="editor-container">
    <div class="row g-0 h-100">
        <!-- Sidebar -->
        <div class="col-lg-3 editor-sidebar">
            <div class="p-3">
                <h6>Page: {{ page.title }}</h6>
                <p class="text-muted small">{{ page.site.title }}</p>
                
                <!-- Components Panel -->
                <div class="mb-4">
                    <h6>Components</h6>
                    <div id="components-list">
                        <div class="component-item" data-component="heading">
                            <i class="fas fa-heading"></i> Heading
                        </div>
                        <div class="component-item" data-component="text">
                            <i class="fas fa-paragraph"></i> Text Block
                        </div>
                        <div class="component-item" data-component="image">
                            <i class="fas fa-image"></i> Image
                        </div>
                        <div class="component-item" data-component="button">
                            <i class="fas fa-mouse-pointer"></i> Button
                        </div>
                        <div class="component-item" data-component="divider">
                            <i class="fas fa-minus"></i> Divider
                        </div>
                        <div class="component-item" data-component="spacer">
                            <i class="fas fa-arrows-alt-v"></i> Spacer
                        </div>
                    </div>
                </div>
                
                <!-- Properties Panel -->
                <div id="properties-panel" class="properties-panel" style="display: none;">
                    <h6>Properties</h6>
                    <div id="properties-content">
                        <!-- Properties will be populated here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main Editor -->
        <div class="col-lg-9 editor-content">
            <!-- Toolbar -->
            <div class="editor-toolbar">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="preview-btn">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="save-btn">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                    
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success" id="publish-btn">
                            <i class="fas fa-upload"></i> Publish
                        </button>
                        <a href="{{ url_for('sites.site_detail', site_id=page.site.id) }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Canvas -->
            <div class="editor-canvas">
                <div class="page-canvas" id="page-canvas">
                    <div class="editable-element" data-type="heading">
                        <div class="element-toolbar">
                            <button class="btn btn-sm btn-outline-light" onclick="editElement(this)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="deleteElement(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <h1>{{ page.title }}</h1>
                    </div>
                    
                    <div class="editable-element" data-type="text">
                        <div class="element-toolbar">
                            <button class="btn btn-sm btn-outline-light" onclick="editElement(this)">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" onclick="deleteElement(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <p>{{ page.description or 'Nội dung page sẽ được hiển thị ở đây. Click để chỉnh sửa.' }}</p>
                    </div>
                    
                    <!-- Drop zone for new components -->
                    <div class="text-center py-4" id="drop-zone">
                        <p class="text-muted">
                            <i class="fas fa-plus-circle"></i> 
                            Kéo components từ sidebar vào đây hoặc click để thêm nội dung
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Element Modal -->
<div class="modal fade" id="editElementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Element</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="edit-form">
                    <!-- Edit form will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-element-btn">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentEditingElement = null;
let pageData = {
    id: {{ page.id }},
    title: "{{ page.title }}",
    content: "{{ page.content|default('') }}"
};

// Component templates
const componentTemplates = {
    heading: '<h2>New Heading</h2>',
    text: '<p>New text block. Click to edit this content.</p>',
    image: '<img src="https://via.placeholder.com/400x200" class="img-fluid" alt="Placeholder">',
    button: '<button class="btn btn-primary">Click Me</button>',
    divider: '<hr>',
    spacer: '<div style="height: 40px;"></div>'
};

// Make elements editable
document.addEventListener('DOMContentLoaded', function() {
    makeElementsEditable();
    setupComponentDragDrop();
});

function makeElementsEditable() {
    const editableElements = document.querySelectorAll('.editable-element');
    editableElements.forEach(element => {
        element.addEventListener('click', function() {
            selectElement(this);
        });
    });
}

function selectElement(element) {
    // Remove previous selection
    document.querySelectorAll('.editable-element.selected').forEach(el => {
        el.classList.remove('selected');
    });
    
    // Select current element
    element.classList.add('selected');
    currentEditingElement = element;
    
    // Show properties panel
    showPropertiesPanel(element);
}

function showPropertiesPanel(element) {
    const panel = document.getElementById('properties-panel');
    const content = document.getElementById('properties-content');
    const type = element.dataset.type;
    
    let propertiesHTML = '';
    
    switch(type) {
        case 'heading':
            propertiesHTML = `
                <div class="mb-3">
                    <label class="form-label">Text</label>
                    <input type="text" class="form-control" id="prop-text" value="${element.querySelector('h1,h2,h3,h4,h5,h6').textContent}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Level</label>
                    <select class="form-select" id="prop-level">
                        <option value="h1">H1</option>
                        <option value="h2">H2</option>
                        <option value="h3">H3</option>
                        <option value="h4">H4</option>
                        <option value="h5">H5</option>
                        <option value="h6">H6</option>
                    </select>
                </div>
            `;
            break;
        case 'text':
            propertiesHTML = `
                <div class="mb-3">
                    <label class="form-label">Content</label>
                    <textarea class="form-control" id="prop-content" rows="4">${element.querySelector('p').textContent}</textarea>
                </div>
            `;
            break;
        case 'button':
            propertiesHTML = `
                <div class="mb-3">
                    <label class="form-label">Text</label>
                    <input type="text" class="form-control" id="prop-text" value="${element.querySelector('button').textContent}">
                </div>
                <div class="mb-3">
                    <label class="form-label">Style</label>
                    <select class="form-select" id="prop-style">
                        <option value="btn-primary">Primary</option>
                        <option value="btn-secondary">Secondary</option>
                        <option value="btn-success">Success</option>
                        <option value="btn-danger">Danger</option>
                        <option value="btn-outline-primary">Outline Primary</option>
                    </select>
                </div>
            `;
            break;
    }
    
    content.innerHTML = propertiesHTML;
    panel.style.display = 'block';
    
    // Add event listeners for property changes
    const inputs = content.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('change', updateElementProperties);
    });
}

function updateElementProperties() {
    if (!currentEditingElement) return;
    
    const type = currentEditingElement.dataset.type;
    
    switch(type) {
        case 'heading':
            const text = document.getElementById('prop-text').value;
            const level = document.getElementById('prop-level').value;
            const heading = currentEditingElement.querySelector('h1,h2,h3,h4,h5,h6');
            heading.outerHTML = `<${level}>${text}</${level}>`;
            break;
        case 'text':
            const content = document.getElementById('prop-content').value;
            currentEditingElement.querySelector('p').textContent = content;
            break;
        case 'button':
            const btnText = document.getElementById('prop-text').value;
            const btnStyle = document.getElementById('prop-style').value;
            const button = currentEditingElement.querySelector('button');
            button.textContent = btnText;
            button.className = `btn ${btnStyle}`;
            break;
    }
}

function setupComponentDragDrop() {
    const components = document.querySelectorAll('.component-item');
    const dropZone = document.getElementById('drop-zone');
    
    components.forEach(component => {
        component.addEventListener('click', function() {
            const componentType = this.dataset.component;
            addComponent(componentType);
        });
    });
}

function addComponent(type) {
    const canvas = document.getElementById('page-canvas');
    const dropZone = document.getElementById('drop-zone');
    
    const newElement = document.createElement('div');
    newElement.className = 'editable-element';
    newElement.dataset.type = type;
    newElement.innerHTML = `
        <div class="element-toolbar">
            <button class="btn btn-sm btn-outline-light" onclick="editElement(this)">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-outline-light" onclick="deleteElement(this)">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        ${componentTemplates[type]}
    `;
    
    canvas.insertBefore(newElement, dropZone);
    makeElementsEditable();
    selectElement(newElement);
}

function editElement(button) {
    const element = button.closest('.editable-element');
    selectElement(element);
}

function deleteElement(button) {
    if (confirm('Bạn có chắc muốn xóa element này?')) {
        const element = button.closest('.editable-element');
        element.remove();
    }
}

// Save functionality
document.getElementById('save-btn').addEventListener('click', function() {
    savePageContent();
});

document.getElementById('publish-btn').addEventListener('click', function() {
    publishPage();
});

function savePageContent() {
    const canvas = document.getElementById('page-canvas');
    const content = canvas.innerHTML;
    
    const btn = document.getElementById('save-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    
    fetch(`/api/pages/${pageData.id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error saving: ' + data.error);
        } else {
            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                Page saved successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving page');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save"></i> Save';
    });
}

function publishPage() {
    const btn = document.getElementById('publish-btn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
    
    // Save first, then publish
    savePageContent();
    
    fetch(`/api/pages/${pageData.id}/publish`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert('Error publishing: ' + data.error);
        } else {
            alert('Page published successfully!\nURL: ' + data.url);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error publishing page');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-upload"></i> Publish';
    });
}

// Auto-save every 30 seconds
setInterval(function() {
    savePageContent();
}, 30000);
</script>
{% endblock %}