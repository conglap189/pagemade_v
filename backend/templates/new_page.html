{% extends "base.html" %}

{% block title %}Tạo Page Mới - {{ site.title }}{% endblock %}

{% block content %}
<div class="min-h-screen py-8 px-4">
  <div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-4">
      <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Tạo Page Mới</h1>
      <p class="text-slate-600 dark:text-slate-400">Tạo page mới cho "{{ site.title }}"</p>
    </div>

    <!-- Form Card -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 p-8">
      <form id="newPageForm" class="space-y-6">
        <input type="hidden" id="site_id" value="{{ site.id }}">
        
        <!-- Tên Page -->
        <div>
          <label for="title" class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
            Tên Page <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 id="title" 
                 name="title" 
                 required
                 placeholder="Ví dụ: Trang chủ, Giới thiệu, Sản phẩm"
                 class="dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30">
          <p class="mt-1.5 text-xs text-gray-500 dark:text-gray-400">
            Chú ý dấu cách
          </p>
        </div>

        <!-- URL Dự kiến -->
        <div>
          <label class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
            URL Dự kiến
          </label>
          <div class="dark:bg-dark-900 shadow-theme-xs h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 flex items-center">
            <span id="urlPreview" class="text-gray-600 dark:text-gray-400">{{ site.subdomain }}.pagemade.site/</span>
          </div>
        </div>

        <!-- Mô tả -->
        <div>
          <label for="description" class="mb-1.5 block text-sm font-medium text-gray-700 dark:text-gray-400">
            Mô tả
          </label>
          <textarea id="description" 
                    name="description" 
                    rows="2"
                    placeholder="Mô tả ngắn về nội dung page này..."
                    class="dark:bg-dark-900 shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 dark:focus:border-brand-800 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden dark:border-gray-700 dark:bg-gray-900 dark:text-white/90 dark:placeholder:text-white/30"></textarea>
        </div>
        
        <!-- Submit Buttons -->
        <div class="flex items-center justify-between pt-4">
          <a href="{{ url_for('main.site_detail', site_id=site.id) }}" 
             class="inline-flex items-center gap-2 px-5 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
            <i class="fas fa-arrow-left"></i>
            Quay lại
          </a>
          
          <button type="submit"
                  class="inline-flex items-center gap-2 px-5 py-3.5 text-sm font-medium text-white transition rounded-lg bg-emerald-500 shadow-theme-xs hover:bg-emerald-600">
            <span>Tạo Page</span>
          </button>
        </div>
                </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Function to create slug from title
function createSlug(title) {
    return title
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[đĐ]/g, 'd')
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim();
}

// Function to update URL preview
function updateUrlPreview() {
    var title = document.getElementById('title').value;
    var urlPreview = document.getElementById('urlPreview');
    var subdomain = '{{ site.subdomain }}';
    
    if (title.trim() === '') {
        urlPreview.textContent = subdomain + '.pagemade.site/';
    } else {
        var slug = createSlug(title);
        urlPreview.textContent = subdomain + '.pagemade.site/' + slug;
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded - initializing new page form');
    
    // Add event listener for real-time preview
    var titleInput = document.getElementById('title');
    if (titleInput) {
        titleInput.addEventListener('input', updateUrlPreview);
        console.log('Title input event listener added');
        // Initialize URL preview
        updateUrlPreview();
    } else {
        console.error('Title input not found');
    }
    
    // Handle form submission
    var form = document.getElementById('newPageForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            var formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                site_id: parseInt(document.getElementById('site_id').value)
            };
            
            console.log('Form data:', formData);
            
            // Basic validation
            if (!formData.title) {
                alert('Vui lòng nhập tên page');
                return;
            }
            
            // Submit form
            var submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Đang tạo...';
            
            fetch('{{ url_for("api.create_page") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('API response:', data);
                if (data.error) {
                    alert(data.error);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Tạo Page';
                } else {
                    console.log('Redirecting to editor with page_id:', data.id);
                    // Success - redirect to editor (which loads editor_pagemaker_v2.html)
                    window.location.href = '/editor/' + data.id;
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                alert('Có lỗi xảy ra khi tạo page');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Tạo Page';
            });
        });
        console.log('Form submit event listener added');
    } else {
        console.error('Form not found');
    }
});
</script>
{% endblock %}