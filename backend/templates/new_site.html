{% extends "base.html" %}

{% block title %}Tạo Site Mới - PageMade{% endblock %}

{% block content %}
<div class="min-h-screen py-12 px-4">
  <div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mb-4 shadow-lg">
        <i class="fas fa-rocket text-white text-2xl"></i>
      </div>
      <h1 class="text-3xl font-bold text-slate-800 dark:text-white mb-2">Tạo Site Mới</h1>
      <p class="text-slate-600 dark:text-slate-400">Xây dựng điều gì đó tuyệt vời trong vài phút</p>
    </div>

    <!-- Form Card -->
    <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl border border-slate-200 dark:border-slate-700 p-8">
      <form id="newSiteForm" class="space-y-6">
        
        <!-- Site Name -->
        <div>
          <label for="title" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
            Tên Site <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fas fa-heading text-slate-400"></i>
            </div>
            <input type="text" 
                   id="title" 
                   name="title" 
                   required
                   placeholder="Ví dụ: Cửa hàng xe của tôi"
                   class="w-full pl-12 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl 
                          text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500
                          focus:ring-2 focus:ring-blue-500 focus:border-transparent
                          transition-all duration-200">
          </div>
        </div>

        <!-- Subdomain -->
        <div>
          <label for="subdomain" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
            Subdomain <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i class="fas fa-link text-slate-400"></i>
            </div>
            <input type="text" 
                   id="subdomain" 
                   name="subdomain" 
                   required
                   pattern="[a-z0-9-]+"
                   placeholder="cuahangxe"
                   class="w-full pl-12 pr-44 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl 
                          text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500
                          focus:ring-2 focus:ring-blue-500 focus:border-transparent
                          transition-all duration-200">
            <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
              <span class="text-slate-500 dark:text-slate-400 font-medium">.pagemade.site</span>
            </div>
          </div>
          <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
            <i class="fas fa-info-circle mr-1"></i>
            Chỉ dùng chữ thường, số và dấu gạch ngang
          </p>
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-2">
            Mô tả
          </label>
          <div class="relative">
            <div class="absolute top-3 left-0 pl-4 pointer-events-none">
              <i class="fas fa-align-left text-slate-400"></i>
            </div>
            <textarea id="description" 
                      name="description" 
                      rows="4"
                      placeholder="Mô tả ngắn về website..."
                      class="w-full pl-12 pr-4 py-3 bg-slate-50 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-xl 
                             text-slate-800 dark:text-white placeholder-slate-400 dark:placeholder-slate-500
                             focus:ring-2 focus:ring-blue-500 focus:border-transparent
                             transition-all duration-200 resize-none"></textarea>
          </div>
        </div>

        <!-- Divider -->
        <div class="relative">
          <div class="absolute inset-0 flex items-center">
            <div class="w-full border-t border-slate-300 dark:border-slate-600"></div>
          </div>
          <div class="relative flex justify-center">
            <span class="px-4 bg-white dark:bg-slate-800 text-sm font-medium text-slate-500 dark:text-slate-400">
              Chọn bước tiếp theo
            </span>
          </div>
        </div>

        <!-- Action Selection -->
        <div>
          <label class="block text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">
            Bước tiếp theo
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            
            <!-- Option 1: Create Basic Site -->
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="action" 
                     value="dashboard" 
                     checked
                     class="peer sr-only">
              <div class="h-full p-6 bg-slate-50 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-xl
                          peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20
                          hover:border-slate-400 dark:hover:border-slate-500
                          transition-all duration-200">
                <div class="flex flex-col items-center text-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-slate-400 to-slate-500 peer-checked:from-blue-500 peer-checked:to-purple-600 rounded-lg flex items-center justify-center mb-3">
                    <i class="fas fa-th-large text-white text-xl"></i>
                  </div>
                  <h3 class="font-bold text-slate-800 dark:text-white mb-1">Tạo Site Cơ Bản</h3>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Quay về Dashboard</p>
                </div>
              </div>
            </label>

            <!-- Option 2: Create & Design -->
            <label class="relative cursor-pointer">
              <input type="radio" 
                     name="action" 
                     value="pagemaker"
                     class="peer sr-only">
              <div class="h-full p-6 bg-slate-50 dark:bg-slate-700 border-2 border-slate-300 dark:border-slate-600 rounded-xl
                          peer-checked:border-blue-500 peer-checked:bg-blue-50 dark:peer-checked:bg-blue-900/20
                          hover:border-slate-400 dark:hover:border-slate-500
                          transition-all duration-200">
                <div class="flex flex-col items-center text-center">
                  <div class="w-12 h-12 bg-gradient-to-br from-slate-400 to-slate-500 peer-checked:from-blue-500 peer-checked:to-purple-600 rounded-lg flex items-center justify-center mb-3">
                    <i class="fas fa-paint-brush text-white text-xl"></i>
                  </div>
                  <h3 class="font-bold text-slate-800 dark:text-white mb-1">Tạo & Thiết Kế</h3>
                  <p class="text-sm text-slate-600 dark:text-slate-400">Vào Editor ngay</p>
                </div>
              </div>
            </label>

          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="flex items-center justify-between pt-4">
          <a href="{{ url_for('main.dashboard') }}" 
             class="inline-flex items-center px-6 py-3 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-xl hover:bg-slate-300 dark:hover:bg-slate-600 transition-all">
            <i class="fas fa-arrow-left mr-2"></i>
            Quay lại
          </a>
          
          <button type="submit" 
                  id="createSiteBtn"
                  class="inline-flex items-center px-8 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all">
            <i class="fas fa-rocket mr-2"></i>
            <span id="btnText">Tạo Site</span>
          </button>
        </div>

      </form>
    </div>

    <!-- Tips Card -->
    <div class="mt-6 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-xl p-6">
      <div class="flex items-start space-x-4">
        <div class="flex-shrink-0">
          <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center">
            <i class="fas fa-lightbulb text-white"></i>
          </div>
        </div>
        <div>
          <h3 class="font-semibold text-blue-900 dark:text-blue-100 mb-2">Mẹo hay</h3>
          <ul class="space-y-1 text-sm text-blue-800 dark:text-blue-200">
            <li><i class="fas fa-check-circle mr-2"></i>Chọn tên subdomain dễ nhớ</li>
            <li><i class="fas fa-check-circle mr-2"></i>Giữ tên site ngắn gọn và mô tả</li>
            <li><i class="fas fa-check-circle mr-2"></i>Bạn có thể chỉnh sửa thông tin này sau</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('newSiteForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const btn = document.getElementById('createSiteBtn');
  const btnText = document.getElementById('btnText');
  const originalText = btnText.textContent;
  // Get form data
  const title = document.getElementById('title').value.trim();
  const subdomain = document.getElementById('subdomain').value.trim().toLowerCase();
  const description = document.getElementById('description').value.trim();
  const action = document.querySelector('input[name="action"]:checked').value;
  // Validation
  if (!title || !subdomain) {
    alert('Vui lòng điền đầy đủ thông tin bắt buộc');
    return;
  }
  // Subdomain format validation
  const subdomainPattern = /^[a-z0-9-]+$/;
  if (!subdomainPattern.test(subdomain)) {
    alert('❌ Subdomain chỉ được chứa chữ thường, số và dấu gạch ngang');
    return;
  }
  // Update button
  btn.disabled = true;
  btnText.textContent = 'Đang tạo...';
  btn.classList.add('opacity-75');
  try {
    const response = await fetch('{{ url_for("main.new_site") }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        title: title,
        subdomain: subdomain,
        description: description,
        action: action
      })
    });
    const result = await response.json();
    if (result.success) {
      btnText.textContent = 'Thành công!';
      btn.classList.remove('opacity-75');
      // Redirect tuỳ action
      setTimeout(() => {
        if (action === 'dashboard') {
          window.location.href = '/dashboard';
        } else if (action === 'pagemaker') {
          // Nếu backend trả về page_id, dùng nó, nếu không thì chỉ redirect tới editor_pagemaker.html
          if (result.page_id) {
            window.location.href = `/editor/${result.page_id}`;
          } else {
            window.location.href = '/editor_pagemaker.html';
          }
        } else {
          window.location.href = '/dashboard';
        }
      }, 500);
    } else {
      throw new Error(result.message || 'Không thể tạo site');
    }
  } catch (error) {
    console.error('Error:', error);
    alert(error.message || 'Có lỗi xảy ra. Vui lòng thử lại.');
    btn.disabled = false;
    btnText.textContent = originalText;
    btn.classList.remove('opacity-75');
  }
});

// Update button text based on selected action
document.querySelectorAll('input[name="action"]').forEach(radio => {
  radio.addEventListener('change', function() {
    const btnText = document.getElementById('btnText');
    if (this.value === 'pagemaker') {
      btnText.textContent = 'Tạo Site & Thiết Kế';
    } else {
      btnText.textContent = 'Tạo Site';
    }
  });
});
</script>
{% endblock %}