<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagemade Editor - {{ page.title }}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/branding/favicon/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/branding/favicon/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/branding/favicon/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/branding/favicon/apple-touch-icon.png') }}">
    <meta name="theme-color" content="#667eea">
    
    <!-- PageMaker CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='pagemaker/pagemaker.min.css') }}">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* ===== TOP TOOLBAR ===== */
        #top-toolbar {
            height: 60px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            position: relative;
        }
        
        /* Dark mode styles */
        .dark #top-toolbar {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }
        
        #top-toolbar .left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-right: 20px;
            border-right: 1px solid #e5e7eb;
        }
        
        .logo-section img {
            height: 32px;
            width: auto;
        }
        
        .page-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .page-title {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .dark .page-title {
            color: #f9fafb;
        }
        
        .page-subtitle {
            font-size: 12px;
            color: #6b7280;
        }
        
        .dark .page-subtitle {
            color: #9ca3af;
        }
        
        .device-switcher {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .dark .device-switcher {
            background: #374151;
        }
        
        .device-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-radius: 6px;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .device-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }
        
        .dark .device-btn {
            color: #9ca3af;
        }
        
        .dark .device-btn:hover {
            background: #4b5563;
            color: #f9fafb;
        }
        
        .device-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dark .device-btn.active {
            background: #1f2937;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        #top-toolbar .right {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .lang-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }
        
        .dark .lang-selector {
            background: #374151;
            color: #9ca3af;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-save {
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .btn-save:hover {
            background: #e5e7eb;
        }
        
        .dark .btn-save {
            background: #374151;
            color: #f9fafb;
        }
        
        .dark .btn-save:hover {
            background: #4b5563;
        }
        
        .btn-publish {
            background: #10b981;
            color: white;
            border-radius: 8px;
            font-weight: 500;
            justify-content: center;
        }
        
        .btn-publish:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .btn-back {
            background: transparent;
            color: #6b7280;
            padding: 8px 12px;
        }
        
        .btn-back:hover {
            background: #f3f4f6;
        }
        
        .dark .btn-back {
            color: #9ca3af;
        }
        
        .dark .btn-back:hover {
            background: #374151;
        }
        
        .btn-preview {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            font-weight: 500;
        }
        
        .btn-preview:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .btn-preview.loading {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-preview.success {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .btn-preview.error {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }
        
        .dark .btn-preview {
            color: #818cf8;
            border-color: #818cf8;
        }
        
        .dark .btn-preview:hover {
            background: #818cf8;
            color: white;
        }
        
        /* ===== MAIN EDITOR LAYOUT ===== */
        #editor-wrapper {
            display: flex;
            height: calc(100vh - 60px); /* Full height minus top toolbar */
            background: #f9fafb;
            margin: 0;
            padding: 0;
        }
        
        .dark #editor-wrapper {
            background: #111827;
        }
        
        /* ===== LEFT SIDEBAR ===== */
        #left-sidebar {
            width: 60px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 4px;
        }
        
        .dark #left-sidebar {
            background: #1f2937;
            border-right: 1px solid #374151;
        }
        
        .sidebar-btn {
            width: 44px;
            height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 18px;
            position: relative;
        }
        
        .sidebar-btn:hover {
            background: #f3f4f6;
            color: #667eea;
        }
        
        .dark .sidebar-btn {
            color: #9ca3af;
        }
        
        .dark .sidebar-btn:hover {
            background: #374151;
            color: #667eea;
        }
        
        .sidebar-btn.active {
            background: #ede9fe;
            color: #667eea;
        }
        
        .dark .sidebar-btn.active {
            background: #312e81;
        }
        
        .sidebar-btn.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            bottom: 8px;
            width: 3px;
            background: #667eea;
            border-radius: 0 3px 3px 0;
        }
        
        .sidebar-btn-label {
            font-size: 10px;
            font-weight: 500;
        }
        
        .sidebar-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #ef4444;
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* ===== LEFT PANEL (Blocks, Layers, etc) ===== */
        #left-panel {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: none;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .dark #left-panel {
            background: #1f2937;
            border-right: 1px solid #374151;
        }
        
        #left-panel.active {
            display: flex;
        }
        
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .dark .panel-header {
            border-bottom: 1px solid #374151;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .dark .panel-title {
            color: #f9fafb;
        }
        
        .panel-subtitle {
            font-size: 12px;
            color: #6b7280;
        }
        
        .dark .panel-subtitle {
            color: #9ca3af;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        /* Blocks container - minimal styling, let plugin handle the rest */
        #blocks-container {
            display: block !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        
        /* ===== CANVAS AREA ===== */
        #canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            margin: 0;
            padding: 10px;
            background: #f3f4f6;
            transition: all 0.3s ease;
        }
        
        .dark #canvas-area {
            background: #111827;
        }
        
        #gjs {
            flex: 1;
            position: relative;
            margin: 0;
            padding: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .dark #gjs {
            background: #1f2937;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Canvas states for different sidebar combinations */
        #canvas-area.both-sidebars {
            padding: 10px;
        }
        
        #canvas-area.left-only {
            padding: 10px 10px 10px 10px;
        }
        
        #canvas-area.right-only {
            padding: 10px 10px 10px 10px;
        }
        
        #canvas-area.no-sidebars {
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ===== EMPTY STATE ===== */
        .pagemaker-empty-state {
            animation: fadeInEmpty 0.5s ease-out;
        }
        
        @keyframes fadeInEmpty {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) translateY(10px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) translateY(0);
            }
        }
        
        .pagemaker-empty-state svg {
            opacity: 0.7;
            margin-bottom: 16px;
        }
        
        .pagemaker-empty-state .tip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-block;
            margin-top: 16px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* ===== RIGHT PANEL (Styles + Properties) ===== */
        #right-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .dark #right-panel {
            background: #1f2937;
            border-left: 1px solid #374151;
        }
        
        /* Tabs for Styles & Properties */
        .right-panel-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .dark .right-panel-tabs {
            background: #111827;
            border-bottom: 1px solid #374151;
        }
        
        .right-panel-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .right-panel-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .right-panel-tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }
        
        .dark .right-panel-tab.active {
            background: #1f2937;
        }
        
        /* Close button for right panel */
        .right-panel-close {
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 1px solid #e5e7eb;
            margin-left: auto;
        }
        
        .dark .right-panel-close {
            color: #9ca3af;
            border-left-color: #374151;
        }
        
        .right-panel-close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }
        
        .dark .right-panel-close:hover {
            color: #f87171;
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* Hide right panel state */
        #right-panel.hidden {
            display: none;
        }
        
        .right-panel-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding: 12px;
        }
        
        .right-panel-content.active {
            display: block;
        }
        
        /* Style container inside right panel */
        #styles-tab #styles-container,
        #properties-tab #traits-container {
            padding: 0;
        }
        
        /* ===== PageMaker Custom Styles ===== */
        .gjs-one-bg {
            background-color: #f9fafb;
        }
        
        .dark .gjs-one-bg {
            background-color: #111827;
        }
        
        .gjs-two-color {
            color: #667eea;
        }
        
        .gjs-three-bg {
            background-color: #667eea;
            color: white;
        }
        
        .gjs-four-color,
        .gjs-four-color-h:hover {
            color: #667eea;
        }
        
        /* ‚úÖ Hide PageMaker default panels/toolbars */
        .gjs-pn-panels {
            display: none !important;
        }
        
        .gjs-pn-devices-c {
            display: none !important;
        }
        
        .gjs-pn-views {
            display: none !important;
        }
        
        .gjs-pn-commands {
            display: none !important;
        }
        
        .gjs-pn-options {
            display: none !important;
        }
        
        /* Canvas full width/height - remove all gaps */
        .gjs-cv-canvas {
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }
        
        .gjs-cv-canvas__frames {
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .gjs-frame {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Toolbar styling - changed to blue background */
        .gjs-toolbar {
            background: #667eea !important;
            border: 1px solid #5568d3 !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
        }
        
        /* Toolbar buttons - ensure white icons on blue background */
        .gjs-toolbar .gjs-toolbar-item {
            color: white !important;
        }
        
        .gjs-toolbar .gjs-toolbar-item:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #10b981;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        .loading-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
            background: white;
            padding: 8px;
        }
        
        .spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 32px;
        }
        
        .spinner {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1.2s linear infinite;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .spinner-inner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-bottom-color: #fff;
            animation: spin 0.8s linear infinite reverse;
            position: absolute;
            top: 10px;
            left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        #loading-text {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .loading-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Status Messages */
        .status-message {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .status-message.success {
            background: #10b981;
        }
        
        .status-message.error {
            background: #ef4444;
        }
        
        .status-message.info {
            background: #3b82f6;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-logo">
            <img src="{{ url_for('static', filename='images/branding/logo.svg') }}" alt="PageMade">
        </div>
        
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-inner"></div>
        </div>
        
        <div id="loading-text">ƒêang kh·ªüi t·∫°o PageMade Editor</div>
        <div class="loading-subtitle">ƒêang t·∫£i c√°c c√¥ng c·ª• thi·∫øt k·∫ø...</div>
    </div>
    
    <!-- Top Toolbar -->
    <div id="top-toolbar">
        <div class="left">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='images/branding/logo.svg') }}" alt="PageMade" height="32">
            </div>
            
            <div class="page-info">
                <div class="page-title">{{ page.title }}</div>
                <div class="page-subtitle">{{ page.site.title }}</div>
            </div>
            
            <div class="device-switcher">
                <button class="device-btn active" data-device="Desktop" title="Tablet">
                    <i class="fas fa-tablet-alt"></i>
                </button>
                <button class="device-btn" data-device="Tablet" title="Desktop">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="device-btn" data-device="Mobile" title="Mobile">
                    <i class="fas fa-mobile-alt"></i>
                </button>
            </div>
        </div>
        
        <div class="right">
            <!-- Dark Mode Toggle -->
            <button id="darkModeToggle" 
                class="flex items-center justify-center text-black rounded-full cursor-pointer bg-gray-200 dark:bg-gray-800 h-9 w-9 dark:text-white transition-all duration-300 hover:bg-gray-300 dark:hover:bg-gray-700">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>
            
            <div class="lang-selector">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='15'%3E%3Crect fill='%23da251d' width='20' height='15'/%3E%3Cpolygon fill='%23ff0' points='10,4 11,7 14,7 11.5,9 12.5,12 10,10 7.5,12 8.5,9 6,7 9,7'/%3E%3C/svg%3E" width="20" height="15" alt="VN">
                <span>Ti·∫øng Vi·ªát</span>
                <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
            </div>
            
            <button class="btn btn-back" onclick="window.location.href='{{ url_for('main.site_detail', site_id=page.site_id) }}'">
                <i class="fas fa-arrow-left"></i>
                Quay l·∫°i
            </button>
            
            <button class="btn btn-preview" id="btn-components-view" title="Xem Components">
                <i class="fas fa-layer-group"></i>
                <span>Components</span>
            </button>
            
            <button class="btn btn-save" id="btn-save">
                <i class="fas fa-save"></i>
                L∆∞u
            </button>
            
            <button class="btn btn-publish" id="btn-publish">
                Xu·∫•t b·∫£n
            </button>
        </div>
    </div>
    
    <!-- Main Editor -->
    <div id="editor-wrapper">
        <!-- Left Sidebar -->
        <div id="left-sidebar">
            <button class="sidebar-btn" data-panel="blocks" title="Blocks">
                <i class="fas fa-th-large"></i>
            </button>
            
            <button class="sidebar-btn" data-panel="layers" title="Layers" style="display: none;">
                <i class="fas fa-layer-group"></i>
            </button>
            
            <div style="flex: 1;"></div>
            
            <button class="sidebar-btn" data-panel="settings" title="Settings" style="display: none;">
                <i class="fas fa-cog"></i>
            </button>
            
            <button class="sidebar-btn" data-panel="help" title="Help" style="display: none;">
                <i class="fas fa-question-circle"></i>
            </button>
        </div>
        
        <!-- Left Panel (Blocks only) -->
        <div id="left-panel" class="active">
            <div class="panel-header">
                <div class="panel-title">Blocks</div>
                <div class="panel-subtitle">K√©o & th·∫£ ƒë·ªÉ th√™m v√†o trang</div>
            </div>
            
            <div class="panel-content" id="blocks-container">
                <!-- PageMaker blocks will be injected here -->
            </div>
        </div>
        
        <!-- Canvas Area -->
        <div id="canvas-area">
            <div id="gjs"></div>
        </div>
        
        <!-- Right Panel (Styles + Properties with Tabs) -->
        <div id="right-panel">
            <div class="right-panel-tabs">
                <button class="right-panel-tab active" data-tab="styles">
                    <i class="fas fa-palette"></i> Styles
                </button>
                <button class="right-panel-tab" data-tab="properties">
                    <i class="fas fa-cog"></i> Properties
                </button>
                <button class="right-panel-close" id="right-panel-close" title="ƒê√≥ng">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="right-panel-content active" id="styles-tab">
                <div id="styles-container">
                    <!-- PageMaker style manager will be injected here -->
                </div>
            </div>
            
            <div class="right-panel-content" id="properties-tab">
                <div id="traits-container">
                    <!-- PageMaker properties panel will be injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PageMaker Core Engine -->
    <script src="{{ url_for('static', filename='pagemaker/pagemaker.min.js') }}"></script>
    
    <!-- PageMaker Tailwind Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/grapesjs-tailwind@1/dist/grapesjs-tailwind.min.js"></script>
    
    <script>
        console.log('üöÄ PageMaker Editor v2 initializing...');
        
        // ===== DARK MODE TOGGLE =====
        const darkModeToggle = document.getElementById('darkModeToggle');
        const html = document.documentElement;
        const currentTheme = localStorage.getItem('theme') || 'light';
        html.classList.toggle('dark', currentTheme === 'dark');
        darkModeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
        });
        
        // ===== CANVAS RESPONSIVE LOGIC =====
        const canvasArea = document.getElementById('canvas-area');
        
        function updateCanvasLayout() {
            const leftPanelVisible = leftPanel.classList.contains('active');
            const rightPanelVisible = !rightPanel.classList.contains('hidden');
            
            // Remove all canvas state classes
            canvasArea.classList.remove('both-sidebars', 'left-only', 'right-only', 'no-sidebars');
            
            // Add appropriate class based on sidebar states
            if (leftPanelVisible && rightPanelVisible) {
                canvasArea.classList.add('both-sidebars');
            } else if (leftPanelVisible && !rightPanelVisible) {
                canvasArea.classList.add('left-only');
            } else if (!leftPanelVisible && rightPanelVisible) {
                canvasArea.classList.add('right-only');
            } else {
                canvasArea.classList.add('no-sidebars');
            }
        }
        
        // ===== LEFT SIDEBAR TOGGLE (Initialize before editor) =====
        const leftSidebar = document.getElementById('left-sidebar');
        const leftPanel = document.getElementById('left-panel');
        const sidebarButtons = leftSidebar.querySelectorAll('.sidebar-btn');
        
        sidebarButtons.forEach((btn) => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const panel = btn.getAttribute('data-panel');
                const isActive = btn.classList.contains('active');
                
                // If clicking same button - deactivate it
                if (isActive) {
                    btn.classList.remove('active');
                    leftPanel.classList.remove('active');
                } else {
                    // Activate new button
                    sidebarButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    leftPanel.classList.add('active');
                    
                    // Render blocks if this is blocks panel
                    if (panel === 'blocks' && window.editor) {
                        setTimeout(() => {
                            const blocksContainer = document.getElementById('blocks-container');
                            const blockManager = window.editor.BlockManager;
                            const blocksEl = blockManager.render();
                            
                            if (blocksContainer && blocksEl) {
                                blocksContainer.innerHTML = '';
                                blocksContainer.appendChild(blocksEl);
                            }
                        }, 50);
                    }
                }
                
                // Update canvas layout after sidebar toggle
                setTimeout(updateCanvasLayout, 100);
            });
        });
        

        
        // ===== RIGHT PANEL TABS (Initialize before editor) =====
        const rightPanelTabs = document.querySelectorAll('.right-panel-tab');
        const rightPanelContents = document.querySelectorAll('.right-panel-content');
        
        rightPanelTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Remove active from all tabs and contents
                rightPanelTabs.forEach(t => t.classList.remove('active'));
                rightPanelContents.forEach(c => c.classList.remove('active'));
                
                // Add active to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });
        
        // ===== PAGE DATA =====
        const PAGE_ID = {{ page.id }};
        const SITE_ID = {{ page.site_id }};
        const PAGE_TITLE = "{{ page.title }}";
        
        // API endpoints
        const LOAD_URL = `/api/pages/${PAGE_ID}/pagemaker/load`;
        const SAVE_URL = `/api/pages/${PAGE_ID}/pagemaker/save`;
        const PUBLISH_URL = `/api/pages/${PAGE_ID}/publish`;
        const PREVIEW_URL = `/api/pages/${PAGE_ID}/preview`;
        
        // Initialize PageMaker Editor
        const editor = pagemaker.init({
            container: '#gjs',
            height: '100%',
            width: 'auto',
            
            // ‚úÖ Hide default panels and toolbars
            showOffsets: false,
            noticeOnUnload: false,
            
            // Storage Manager - Disabled (we handle save/load manually)
            storageManager: false,
            
            // Plugins
            plugins: ['grapesjs-tailwind'],
            pluginsOpts: {
                'grapesjs-tailwind': {
                    openCategory: 'Blog', // Default open category
                    loadBlocks: true, // Load all Tailwind blocks
                }
            },
            
            // Block Manager
            blockManager: {
                appendTo: '#blocks-container',
                // ‚úÖ Sort blocks by category
                custom: true,
            },
            
            // Style Manager - Complete CSS Properties
            styleManager: {
                appendTo: '#styles-container',
                sectors: [
                    {
                        name: 'Layout',
                        open: false,
                        buildProps: ['display', 'flex-direction', 'justify-content', 'align-items', 'align-content', 'flex-wrap', 'gap', 'float', 'clear', 'overflow', 'overflow-x', 'overflow-y'],
                        properties: [
                            {
                                type: 'select',
                                property: 'display',
                                default: 'block',
                                options: [
                                    { value: 'block', name: 'Block' },
                                    { value: 'inline', name: 'Inline' },
                                    { value: 'inline-block', name: 'Inline Block' },
                                    { value: 'flex', name: 'Flex' },
                                    { value: 'inline-flex', name: 'Inline Flex' },
                                    { value: 'grid', name: 'Grid' },
                                    { value: 'inline-grid', name: 'Inline Grid' },
                                    { value: 'none', name: 'None' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'flex-direction',
                                default: 'row',
                                options: [
                                    { value: 'row', name: 'Row' },
                                    { value: 'row-reverse', name: 'Row Reverse' },
                                    { value: 'column', name: 'Column' },
                                    { value: 'column-reverse', name: 'Column Reverse' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'justify-content',
                                default: 'flex-start',
                                options: [
                                    { value: 'flex-start', name: 'Start' },
                                    { value: 'center', name: 'Center' },
                                    { value: 'flex-end', name: 'End' },
                                    { value: 'space-between', name: 'Space Between' },
                                    { value: 'space-around', name: 'Space Around' },
                                    { value: 'space-evenly', name: 'Space Evenly' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'align-items',
                                default: 'stretch',
                                options: [
                                    { value: 'stretch', name: 'Stretch' },
                                    { value: 'flex-start', name: 'Start' },
                                    { value: 'center', name: 'Center' },
                                    { value: 'flex-end', name: 'End' },
                                    { value: 'baseline', name: 'Baseline' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'flex-wrap',
                                default: 'nowrap',
                                options: [
                                    { value: 'nowrap', name: 'No Wrap' },
                                    { value: 'wrap', name: 'Wrap' },
                                    { value: 'wrap-reverse', name: 'Wrap Reverse' },
                                ],
                            },
                        ]
                    },
                    {
                        name: 'Size',
                        open: false,
                        buildProps: ['width', 'height', 'max-width', 'min-width', 'max-height', 'min-height'],
                        properties: [
                            {
                                property: 'width',
                                type: 'integer',
                                units: ['px', '%', 'vw', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'height',
                                type: 'integer',
                                units: ['px', '%', 'vh', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'max-width',
                                type: 'integer',
                                units: ['px', '%', 'vw', 'em', 'rem', 'none'],
                                default: 'none',
                            },
                            {
                                property: 'min-width',
                                type: 'integer',
                                units: ['px', '%', 'vw', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'max-height',
                                type: 'integer',
                                units: ['px', '%', 'vh', 'em', 'rem', 'none'],
                                default: 'none',
                            },
                            {
                                property: 'min-height',
                                type: 'integer',
                                units: ['px', '%', 'vh', 'em', 'rem'],
                                default: '0',
                            },
                        ]
                    },
                    {
                        name: 'Space',
                        open: false,
                        buildProps: ['margin-top', 'margin-right', 'margin-bottom', 'margin-left', 'padding-top', 'padding-right', 'padding-bottom', 'padding-left'],
                        properties: [
                            {
                                property: 'margin-top',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'margin-right',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'margin-bottom',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'margin-left',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'padding-top',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'padding-right',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'padding-bottom',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'padding-left',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                        ]
                    },
                    {
                        name: 'Position',
                        open: false,
                        buildProps: ['position', 'top', 'right', 'bottom', 'left', 'z-index'],
                        properties: [
                            {
                                type: 'select',
                                property: 'position',
                                default: 'static',
                                options: [
                                    { value: 'static', name: 'Static' },
                                    { value: 'relative', name: 'Relative' },
                                    { value: 'absolute', name: 'Absolute' },
                                    { value: 'fixed', name: 'Fixed' },
                                    { value: 'sticky', name: 'Sticky' },
                                ],
                            },
                            {
                                property: 'top',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'right',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'bottom',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'left',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'z-index',
                                type: 'integer',
                                default: 'auto',
                            },
                        ]
                    },
                    {
                        name: 'Typography',
                        open: false,
                        buildProps: ['font-family', 'font-size', 'font-weight', 'font-style', 'line-height', 'letter-spacing', 'word-spacing', 'text-align', 'text-decoration', 'text-transform', 'color', 'text-shadow'],
                        properties: [
                            {
                                property: 'font-family',
                                type: 'select',
                                default: 'inherit',
                                options: [
                                    { value: 'inherit', name: 'Inherit' },
                                    { value: 'Arial, sans-serif', name: 'Arial' },
                                    { value: 'Helvetica, sans-serif', name: 'Helvetica' },
                                    { value: 'Georgia, serif', name: 'Georgia' },
                                    { value: '"Times New Roman", serif', name: 'Times New Roman' },
                                    { value: '"Courier New", monospace', name: 'Courier New' },
                                    { value: 'Verdana, sans-serif', name: 'Verdana' },
                                    { value: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', name: 'System Font' },
                                ],
                            },
                            {
                                property: 'font-size',
                                type: 'integer',
                                units: ['px', 'em', 'rem', '%', 'pt'],
                                default: '16px',
                            },
                            {
                                type: 'select',
                                property: 'font-weight',
                                default: '400',
                                options: [
                                    { value: '100', name: 'Thin (100)' },
                                    { value: '200', name: 'Extra Light (200)' },
                                    { value: '300', name: 'Light (300)' },
                                    { value: '400', name: 'Normal (400)' },
                                    { value: '500', name: 'Medium (500)' },
                                    { value: '600', name: 'Semi Bold (600)' },
                                    { value: '700', name: 'Bold (700)' },
                                    { value: '800', name: 'Extra Bold (800)' },
                                    { value: '900', name: 'Black (900)' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'font-style',
                                default: 'normal',
                                options: [
                                    { value: 'normal', name: 'Normal' },
                                    { value: 'italic', name: 'Italic' },
                                    { value: 'oblique', name: 'Oblique' },
                                ],
                            },
                            {
                                property: 'line-height',
                                type: 'integer',
                                units: ['', 'px', 'em', 'rem', '%'],
                                default: 'normal',
                            },
                            {
                                property: 'letter-spacing',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: 'normal',
                            },
                            {
                                type: 'select',
                                property: 'text-align',
                                default: 'left',
                                options: [
                                    { value: 'left', name: 'Left' },
                                    { value: 'center', name: 'Center' },
                                    { value: 'right', name: 'Right' },
                                    { value: 'justify', name: 'Justify' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'text-decoration',
                                default: 'none',
                                options: [
                                    { value: 'none', name: 'None' },
                                    { value: 'underline', name: 'Underline' },
                                    { value: 'overline', name: 'Overline' },
                                    { value: 'line-through', name: 'Line Through' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'text-transform',
                                default: 'none',
                                options: [
                                    { value: 'none', name: 'None' },
                                    { value: 'uppercase', name: 'UPPERCASE' },
                                    { value: 'lowercase', name: 'lowercase' },
                                    { value: 'capitalize', name: 'Capitalize' },
                                ],
                            },
                            {
                                property: 'color',
                                type: 'color',
                                default: '#000000',
                            },
                            {
                                property: 'text-shadow',
                                type: 'stack',
                                default: 'none',
                            },
                        ]
                    },
                    {
                        name: 'Background',
                        open: false,
                        buildProps: ['background-color', 'background-image', 'background-size', 'background-position', 'background-repeat', 'background-attachment'],
                        properties: [
                            {
                                property: 'background-color',
                                type: 'color',
                                default: 'transparent',
                            },
                            {
                                property: 'background-image',
                                type: 'file',
                                default: 'none',
                            },
                            {
                                type: 'select',
                                property: 'background-size',
                                default: 'auto',
                                options: [
                                    { value: 'auto', name: 'Auto' },
                                    { value: 'cover', name: 'Cover' },
                                    { value: 'contain', name: 'Contain' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'background-position',
                                default: 'left top',
                                options: [
                                    { value: 'left top', name: 'Left Top' },
                                    { value: 'center top', name: 'Center Top' },
                                    { value: 'right top', name: 'Right Top' },
                                    { value: 'left center', name: 'Left Center' },
                                    { value: 'center center', name: 'Center Center' },
                                    { value: 'right center', name: 'Right Center' },
                                    { value: 'left bottom', name: 'Left Bottom' },
                                    { value: 'center bottom', name: 'Center Bottom' },
                                    { value: 'right bottom', name: 'Right Bottom' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'background-repeat',
                                default: 'repeat',
                                options: [
                                    { value: 'repeat', name: 'Repeat' },
                                    { value: 'repeat-x', name: 'Repeat X' },
                                    { value: 'repeat-y', name: 'Repeat Y' },
                                    { value: 'no-repeat', name: 'No Repeat' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'background-attachment',
                                default: 'scroll',
                                options: [
                                    { value: 'scroll', name: 'Scroll' },
                                    { value: 'fixed', name: 'Fixed' },
                                    { value: 'local', name: 'Local' },
                                ],
                            },
                        ]
                    },
                    {
                        name: 'Borders',
                        open: false,
                        buildProps: ['border-top-width', 'border-right-width', 'border-bottom-width', 'border-left-width', 'border-style', 'border-color', 'border-top-left-radius', 'border-top-right-radius', 'border-bottom-right-radius', 'border-bottom-left-radius'],
                        properties: [
                            {
                                property: 'border-top-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-right-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-bottom-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-left-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                type: 'select',
                                property: 'border-style',
                                default: 'solid',
                                options: [
                                    { value: 'none', name: 'None' },
                                    { value: 'solid', name: 'Solid' },
                                    { value: 'dotted', name: 'Dotted' },
                                    { value: 'dashed', name: 'Dashed' },
                                    { value: 'double', name: 'Double' },
                                    { value: 'groove', name: 'Groove' },
                                    { value: 'ridge', name: 'Ridge' },
                                    { value: 'inset', name: 'Inset' },
                                    { value: 'outset', name: 'Outset' },
                                ],
                            },
                            {
                                property: 'border-color',
                                type: 'color',
                                default: '#000000',
                            },
                            {
                                property: 'border-top-left-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-top-right-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-bottom-right-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-bottom-left-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                        ]
                    },
                    {
                        name: 'Effects',
                        open: false,
                        buildProps: ['opacity', 'box-shadow', 'transform', 'transition', 'cursor', 'filter'],
                        properties: [
                            {
                                property: 'opacity',
                                type: 'slider',
                                default: '1',
                                min: 0,
                                max: 1,
                                step: 0.01,
                            },
                            {
                                property: 'box-shadow',
                                type: 'stack',
                                default: 'none',
                            },
                            {
                                property: 'transform',
                                type: 'stack',
                                default: 'none',
                            },
                            {
                                property: 'transition',
                                type: 'stack',
                                default: 'none',
                            },
                            {
                                type: 'select',
                                property: 'cursor',
                                default: 'auto',
                                options: [
                                    { value: 'auto', name: 'Auto' },
                                    { value: 'default', name: 'Default' },
                                    { value: 'pointer', name: 'Pointer' },
                                    { value: 'text', name: 'Text' },
                                    { value: 'move', name: 'Move' },
                                    { value: 'not-allowed', name: 'Not Allowed' },
                                    { value: 'grab', name: 'Grab' },
                                    { value: 'grabbing', name: 'Grabbing' },
                                ],
                            },
                            {
                                property: 'filter',
                                type: 'stack',
                                default: 'none',
                            },
                        ]
                    }
                ],
            },
            
            // Layer Manager
            layerManager: {
                appendTo: '#layers-container',
            },
            
            // Trait Manager
            traitManager: {
                appendTo: '#traits-container',
            },
            
            // Canvas settings
            canvas: {
                styles: [],
                scripts: [],
            },
            
            // Device Manager
            deviceManager: {
                devices: [
                    {
                        name: 'Desktop',
                        width: '',
                    },
                    {
                        name: 'Tablet',
                        width: '768px',
                        widthMedia: '992px',
                    },
                    {
                        name: 'Mobile',
                        width: '320px',
                        widthMedia: '480px',
                    }
                ]
            },
        });
        
        // Expose editor to window for debugging and panel toggle
        window.editor = editor;
        console.log('‚úÖ Editor initialized');
        
        console.log('‚úÖ Using PageMaker Tailwind plugin blocks');
        
        // ===== Empty State Management =====
        
        function checkEmptyState() {
            const canvas = editor.Canvas.getDocument();
            const body = canvas.querySelector('body');
            const hasContent = body && body.children.length > 0;
            
            if (!hasContent) {
                showEmptyState();
            } else {
                hideEmptyState();
            }
        }
        
        function showEmptyState() {
            const canvas = editor.Canvas.getDocument();
            const body = canvas.querySelector('body');
            
            if (body && !body.querySelector('.pagemaker-empty-state')) {
                body.innerHTML = `
                    <div class="pagemaker-empty-state" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        color: #64748b;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        pointer-events: none;
                        z-index: 1000;
                        max-width: 400px;
                        padding: 40px 20px;
                    ">
                        <div style="margin-bottom: 32px;">
                            <div style="
                                width: 120px;
                                height: 80px;
                                background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
                                border: 2px dashed #cbd5e1;
                                border-radius: 12px;
                                margin: 0 auto 20px auto;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                position: relative;
                            ">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21,15 16,10 5,21"/>
                                </svg>
                                
                                <!-- Floating plus icon -->
                                <div style="
                                    position: absolute;
                                    bottom: -8px;
                                    right: -8px;
                                    width: 24px;
                                    height: 24px;
                                    background: #667eea;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                                ">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="
                            font-size: 28px;
                            font-weight: 700;
                            margin: 0 0 16px 0;
                            color: #1f2937;
                            line-height: 1.2;
                        ">
                            B·∫Øt ƒë·∫ßu x√¢y d·ª±ng trang c·ªßa b·∫°n!
                        </h3>
                        
                        <p style="
                            font-size: 16px;
                            margin: 0 0 32px 0;
                            color: #6b7280;
                            line-height: 1.5;
                        ">
                            K√©o v√† th·∫£ c√°c blocks t·ª´ sidebar b√™n tr√°i ƒë·ªÉ t·∫°o n·ªôi dung chuy√™n nghi·ªáp
                        </p>
                        
                        <div style="
                            display: inline-flex;
                            align-items: center;
                            gap: 12px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 14px 24px;
                            border-radius: 25px;
                            font-size: 14px;
                            font-weight: 500;
                            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
                            margin-bottom: 20px;
                        ">
                            <span style="font-size: 16px;">‚ú®</span>
                            <span>Th·ª≠ b·∫Øt ƒë·∫ßu v·ªõi Hero Block</span>
                        </div>
                        
                        <div style="
                            font-size: 13px;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            <span>üí°</span>
                            <span>Ho·∫∑c ch·ªçn t·ª´ th∆∞ vi·ªán Tailwind Components</span>
                        </div>
                    </div>
                `;
            }
        }
        
        function hideEmptyState() {
            const canvas = editor.Canvas.getDocument();
            const emptyState = canvas.querySelector('.pagemaker-empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }
        
        // Monitor canvas changes
        editor.on('component:add component:remove', () => {
            setTimeout(checkEmptyState, 100);
        });
        
        // Flag to prevent auto-save during initial load
        let isInitialLoad = true;
        
        // Initial load - Load saved content from API
        editor.on('load', async () => {
            try {
                const response = await fetch(LOAD_URL);
                const data = await response.json();
                
                // Load content into editor
                if (data['gjs-html'] || data['gjs-css'] || (data['gjs-components'] && data['gjs-components'].length > 0)) {
                    // PRIORITY: Load components if available (preserves structure)
                    if (data['gjs-components'] && data['gjs-components'].length > 0) {
                        editor.setComponents(data['gjs-components']);
                        editor.setStyle(data['gjs-styles'] || data['gjs-css'] || '');
                    } else {
                        // Fallback to HTML/CSS only if no components
                        editor.setComponents(data['gjs-html'] || '');
                        editor.setStyle(data['gjs-css'] || '');
                    }
                    console.log('‚úÖ Content loaded');
                }
                
                // Disable initial load flag after 3 seconds
                setTimeout(() => {
                    isInitialLoad = false;
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Load error:', error);
            }
            
            setTimeout(checkEmptyState, 500);
            
            // Set default device to Desktop
            editor.setDevice('Desktop');
            
            // ===== AUTO RENDER BLOCKS on page load =====
            setTimeout(() => {
                const blocksBtn = document.querySelector('.sidebar-btn[data-panel="blocks"]');
                const blocksContainer = document.getElementById('blocks-container');
                const leftPanel = document.getElementById('left-panel');
                
                if (blocksBtn && blocksContainer && leftPanel) {
                    // Show left panel using class
                    leftPanel.classList.add('active');
                    blocksBtn.classList.add('active');
                    
                    // Render blocks
                    const blockManager = editor.BlockManager;
                    const blocksEl = blockManager.render();
                    
                    if (blocksEl) {
                        blocksContainer.innerHTML = '';
                        blocksContainer.appendChild(blocksEl);
                        console.log('‚úÖ Blocks rendered');
                    }
                    
                    // Update canvas layout after initial load
                    setTimeout(updateCanvasLayout, 100);
                }
            }, 1000);
            
            // ===== Load Custom Blocks System =====
            // Import custom blocks from /static/pagemaker/custom-blocks/
            // These blocks will MERGE into existing categories from PageMaker Tailwind plugin
            import('/static/pagemaker/custom-blocks/index.js')
                .then(module => {
                    module.default(editor);
                    console.log('‚úÖ Custom Blocks System loaded');
                })
                .catch(err => {
                    // Silent fail - OK if no custom blocks defined yet
                });
        });
        
        // ===== RIGHT PANEL TOGGLE LOGIC =====
        const rightPanel = document.getElementById('right-panel');
        const rightPanelClose = document.getElementById('right-panel-close');
        let isRightPanelVisible = true; // Start visible
        
        // Close button functionality
        rightPanelClose.addEventListener('click', () => {
            rightPanel.classList.add('hidden');
            isRightPanelVisible = false;
            // Update canvas layout after hiding right panel
            setTimeout(updateCanvasLayout, 100);
        });
        
        // Function to show right panel
        function showRightPanel() {
            if (!isRightPanelVisible) {
                rightPanel.classList.remove('hidden');
                isRightPanelVisible = true;
                // Update canvas layout after showing right panel
                setTimeout(updateCanvasLayout, 100);
            }
        }
        
        // ===== Auto-switch to Styles when component selected =====
        editor.on('component:selected', (component) => {
            // Show right panel when component is selected
            showRightPanel();
            
            // Auto switch to Styles tab when user selects a component
            const stylesTab = document.querySelector('.right-panel-tab[data-tab="styles"]');
            if (stylesTab) {
                stylesTab.click(); // Trigger click to switch to Styles tab
            }
        });
        
        // Hide right panel when clicking on canvas (no component selected)
        editor.on('component:deselected', () => {
            // Optional: hide panel when deselecting component
            // Comment out if you want panel to stay visible
            // rightPanel.classList.add('hidden');
            // isRightPanelVisible = false;
        });
        
        // ===== UI Controls =====
        
        // Device Switcher
        document.querySelectorAll('.device-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.device-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const device = btn.dataset.device;
                editor.setDevice(device);
            });
        });
        
        // Show status message
        function showStatus(message, type = 'success') {
            const statusEl = document.createElement('div');
            statusEl.className = `status-message ${type}`;
            statusEl.textContent = message;
            document.body.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }
        
        // Components view button state management
        function setComponentsButtonState(state, text = null) {
            const btn = document.getElementById('btn-components-view');
            const icon = btn.querySelector('i');
            const span = btn.querySelector('span');
            
            // Remove all state classes
            btn.classList.remove('loading', 'success', 'error');
            
            switch(state) {
                case 'loading':
                    btn.classList.add('loading');
                    icon.className = 'fas fa-spinner fa-spin';
                    if (text) span.textContent = text;
                    break;
                case 'success':
                    btn.classList.add('success');
                    icon.className = 'fas fa-check';
                    if (text) span.textContent = text;
                    setTimeout(() => {
                        setComponentsButtonState('default');
                    }, 2000);
                    break;
                case 'error':
                    btn.classList.add('error');
                    icon.className = 'fas fa-exclamation-triangle';
                    if (text) span.textContent = text;
                    setTimeout(() => {
                        setComponentsButtonState('default');
                    }, 3000);
                    break;
                default:
                    icon.className = 'fas fa-layer-group';
                    span.textContent = 'Components';
                    break;
            }
        }
        
        // Auto-save function (reusable)
        async function autoSaveContent() {
            try {
                console.log('üíæ Auto-saving content...');
                
                // Get current editor state
                const html = editor.getHtml();
                const css = editor.getCss();
                const projectData = editor.getProjectData();
                
                // Prepare save data
                const saveData = {
                    'gjs-html': html,
                    'gjs-css': css,
                    'gjs-components': projectData.pages?.[0]?.frames?.[0]?.component?.components || [],
                    'gjs-styles': projectData.styles || [],
                    'gjs-assets': projectData.assets || []
                };
                
                // Send to API
                const response = await fetch(SAVE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Auto-save response:', result);
                return result;
            } catch (error) {
                console.error('‚ùå Auto-save error:', error);
                throw error;
            }
        }

        // Save button - Custom save implementation
        document.getElementById('btn-save').addEventListener('click', async () => {
            try {
                console.log('üíæ Saving content...');
                
                const result = await autoSaveContent();
                showStatus('ƒê√£ l∆∞u th√†nh c√¥ng!', 'success');
            } catch (error) {
                console.error('‚ùå Save error:', error);
                showStatus('L·ªói khi l∆∞u: ' + error.message, 'error');
            }
        });

        // Components view button handler - Show Component Structure
        document.getElementById('btn-components-view').addEventListener('click', () => {
            try {
                // Get all components in the canvas
                const components = editor.getComponents();
                const componentInfo = [];
                
                // Build component tree
                function buildComponentTree(comp, level = 0) {
                    const indent = '  '.repeat(level);
                    const name = comp.getName() || comp.getType() || 'Component';
                    const id = comp.getId() || 'no-id';
                    const classes = comp.getClasses().join('.') || '';
                    
                    componentInfo.push(`${indent}‚îú‚îÄ ${name} (${id}) ${classes ? '.' + classes : ''}`);
                    
                    // Recursively add children
                    comp.components().each(child => {
                        buildComponentTree(child, level + 1);
                    });
                }
                
                // Build tree from root components
                components.each(comp => {
                    buildComponentTree(comp);
                });
                
                // Create modal to show component structure
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 10000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 24px;
                    max-width: 600px;
                    max-height: 80vh;
                    overflow-y: auto;
                    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                `;
                
                modalContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1f2937; font-size: 18px; font-weight: 600;">
                            <i class="fas fa-layer-group" style="color: #667eea; margin-right: 8px;"></i>
                            Component Structure
                        </h3>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="background: none; border: none; font-size: 20px; cursor: pointer; color: #6b7280;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <pre style="
                        background: #f8fafc;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        padding: 16px;
                        margin: 0;
                        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
                        font-size: 12px;
                        line-height: 1.5;
                        color: #374151;
                        overflow-x: auto;
                    ">${componentInfo.join('\n')}</pre>
                    <div style="margin-top: 16px; text-align: right;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            ƒê√≥ng
                        </button>
                    </div>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // Close modal when clicking outside
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                setComponentsButtonState('success', 'ƒê√£ hi·ªÉn th·ªã');
                setTimeout(() => {
                    setComponentsButtonState('default');
                }, 1500);
                
            } catch (error) {
                console.error('‚ùå Components view error:', error);
                setComponentsButtonState('error', 'L·ªói');
                showStatus('L·ªói khi hi·ªÉn th·ªã components: ' + error.message, 'error');
            }
        });
        
        // Publish button
        // Publish button
        document.getElementById('btn-publish').addEventListener('click', async () => {
            if (!confirm('Xu·∫•t b·∫£n trang n√†y l√™n subdomain? Trang s·∫Ω truy c·∫≠p ƒë∆∞·ª£c c√¥ng khai.')) {
                return;
            }
            
            try {
                showStatus('ƒêang l∆∞u v√† xu·∫•t b·∫£n...', 'info');
                
                // Step 1: Save content first (same as Save button)
                console.log('Saving before publish...');
                
                const html = editor.getHtml();
                const css = editor.getCss();
                const projectData = editor.getProjectData();
                
                const saveData = {
                    'gjs-html': html,
                    'gjs-css': css,
                    'gjs-components': projectData.pages?.[0]?.frames?.[0]?.component?.components || [],
                    'gjs-styles': projectData.styles || [],
                    'gjs-assets': projectData.assets || []
                };
                
                const saveResponse = await fetch(SAVE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });
                
                if (!saveResponse.ok) {
                    throw new Error('Kh√¥ng th·ªÉ l∆∞u n·ªôi dung');
                }
                
                console.log('‚úÖ Content saved, now publishing...');
                
                // Step 2: Publish to subdomain
                const publishResponse = await fetch(PUBLISH_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const result = await publishResponse.json();
                
                if (result.success) {
                    showStatus(`Xu·∫•t b·∫£n th√†nh c√¥ng! M·ªü ${result.subdomain}.pagemade.site...`, 'success');
                    console.log('üöÄ Published to:', result.url);
                    
                    // Open published site in new tab
                    setTimeout(() => {
                        window.open(result.url, '_blank');
                    }, 1500);
                } else {
                    showStatus('L·ªói: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('‚ùå Publish error:', error);
                showStatus('L·ªói khi xu·∫•t b·∫£n: ' + error.message, 'error');
            }
        });
        
        // Hide loading when ready
        editor.on('load', () => {
            console.log('‚úÖ PageMaker Editor loaded!');
            
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                loadingOverlay.style.opacity = '0';
                loadingOverlay.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    loadingOverlay.remove();
                }, 500);
            }, 1000);
        });
        
        // Auto-save every 2 minutes (skip during initial load)
        setInterval(() => {
            if (isInitialLoad) {
                console.log('‚è≠Ô∏è Skipping auto-save during initial load');
                return;
            }
            console.log('üíæ Auto-saving...');
            document.getElementById('btn-save').click();
        }, 2 * 60 * 1000);
        
        console.log('‚úÖ PageMaker Editor v2 initialized');
    </script>
</body>
</html>
