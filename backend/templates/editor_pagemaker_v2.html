<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagemade Editor - {{ page.title }}</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/branding/favicon/favicon.ico') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/branding/favicon/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/branding/favicon/favicon-16x16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/branding/favicon/apple-touch-icon.png') }}">
    <meta name="theme-color" content="#667eea">
    
    <!-- PageMaker CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='pagemaker/pagemaker.min.css') }}">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body, html {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        /* ===== TOP TOOLBAR ===== */
        #top-toolbar {
            height: 60px;
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            position: relative;
        }
        
        /* Dark mode styles */
        .dark #top-toolbar {
            background: #1f2937;
            border-bottom: 1px solid #374151;
        }
        
        #top-toolbar .left {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-right: 20px;
            border-right: 1px solid #e5e7eb;
        }
        
        .logo-section img {
            height: 32px;
            width: auto;
        }
        
        .page-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .page-title {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
        }
        
        .dark .page-title {
            color: #f9fafb;
        }
        
        .page-subtitle {
            font-size: 12px;
            color: #6b7280;
        }
        
        .dark .page-subtitle {
            color: #9ca3af;
        }
        
        .device-switcher {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: #f3f4f6;
            border-radius: 8px;
        }
        
        .dark .device-switcher {
            background: #374151;
        }
        
        .device-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-radius: 6px;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .device-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }
        
        .dark .device-btn {
            color: #9ca3af;
        }
        
        .dark .device-btn:hover {
            background: #4b5563;
            color: #f9fafb;
        }
        
        .device-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .dark .device-btn.active {
            background: #1f2937;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        
        .device-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .device-btn:disabled:hover {
            background: transparent;
            color: #6b7280;
        }
        
        .dark .device-btn:disabled:hover {
            background: transparent;
            color: #9ca3af;
        }
        
        #top-toolbar .right {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .lang-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 6px;
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }
        
        .dark .lang-selector {
            background: #374151;
            color: #9ca3af;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-save {
            background: #f3f4f6;
            color: #1f2937;
        }
        
        .btn-save:hover {
            background: #e5e7eb;
        }
        
        .dark .btn-save {
            background: #374151;
            color: #f9fafb;
        }
        
        .dark .btn-save:hover {
            background: #4b5563;
        }
        
        .btn-publish {
            background: #10b981;
            color: white;
            border-radius: 8px;
            font-weight: 500;
            justify-content: center;
        }
        
        .btn-publish:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }
        
        .btn-back {
            background: transparent;
            color: #6b7280;
            padding: 8px 12px;
        }
        
        .btn-back:hover {
            background: #f3f4f6;
        }
        
        .dark .btn-back {
            color: #9ca3af;
        }
        
        .dark .btn-back:hover {
            background: #374151;
        }
        
        .btn-preview {
            background: transparent;
            color: #667eea;
            border: 2px solid #667eea;
            font-weight: 500;
        }
        
        .btn-preview:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .btn-preview.loading {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-preview.success {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }
        
        .btn-preview.error {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
        }
        
        .dark .btn-preview {
            color: #818cf8;
            border-color: #818cf8;
        }
        
        .dark .btn-preview:hover {
            background: #818cf8;
            color: white;
        }
        
        /* ===== MAIN EDITOR LAYOUT ===== */
        #editor-wrapper {
            display: flex;
            height: calc(100vh - 60px); /* Full height minus top toolbar */
            background: #f9fafb;
            margin: 0;
            padding: 0;
        }
        
        .dark #editor-wrapper {
            background: #111827;
        }
        
        /* ===== LEFT SIDEBAR ===== */
        #left-sidebar {
            width: 60px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 0;
            gap: 4px;
        }
        
        .dark #left-sidebar {
            background: #1f2937;
            border-right: 1px solid #374151;
        }
        
        .sidebar-btn {
            width: 44px;
            height: 44px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 18px;
            position: relative;
        }
        
        .sidebar-btn:hover {
            background: #f3f4f6;
            color: #667eea;
        }
        
        .dark .sidebar-btn {
            color: #9ca3af;
        }
        
        .dark .sidebar-btn:hover {
            background: #374151;
            color: #667eea;
        }
        
        .sidebar-btn.active {
            background: #ede9fe;
            color: #667eea;
        }
        
        .dark .sidebar-btn.active {
            background: #312e81;
        }
        
        .sidebar-btn.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            bottom: 8px;
            width: 3px;
            background: #667eea;
            border-radius: 0 3px 3px 0;
        }
        
        .sidebar-btn-label {
            font-size: 10px;
            font-weight: 500;
        }
        
        .sidebar-badge {
            position: absolute;
            top: 6px;
            right: 6px;
            background: #ef4444;
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 10px;
            font-weight: 600;
        }
        
        /* ===== LEFT PANEL (Blocks, Layers, etc) ===== */
        #left-panel {
            width: 280px;
            background: white;
            border-right: 1px solid #e5e7eb;
            display: none;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .dark #left-panel {
            background: #1f2937;
            border-right: 1px solid #374151;
        }
        
        #left-panel.active {
            display: flex;
        }

        /* Panel sections (Blocks, Layers, Assets) */
        .panel-section {
            display: none;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        
        .panel-section.active {
            display: flex;
        }
        
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .dark .panel-header {
            border-bottom: 1px solid #374151;
        }
        
        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }
        
        .dark .panel-title {
            color: #f9fafb;
        }
        
        .panel-subtitle {
            font-size: 12px;
            color: #6b7280;
        }
        
        .dark .panel-subtitle {
            color: #9ca3af;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        /* Blocks container - minimal styling, let plugin handle the rest */
        #blocks-container {
            display: block !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        
        /* Layers container */
        #layers-container {
            display: block !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        
        /* Assets container */
        #assets-container {
            display: block !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
        }
        
        /* ===== ASSET MANAGER ONLY IN ASSETS PANEL ===== */
        /* Remove all previous hiding CSS and use clean approach */
        /* Asset Manager should only be rendered in assets-container */
        
        /* FORCE HIDE Asset Manager UI elements from Block and Layer panels */
        /* Target specific GrapesJS Asset Manager UI components only */
        #blocks-container .gjs-am-assets,
        #layers-container .gjs-am-assets,
        #blocks-container .gjs-am-file-uploader,
        #layers-container .gjs-am-file-uploader,
        #blocks-container .gjs-am-assets-cont,
        #layers-container .gjs-am-assets-cont,
        #blocks-container .gjs-am-assets-header,
        #layers-container .gjs-am-assets-header {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            width: 0 !important;
            overflow: hidden !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* Hide block category titled "Assets" - use adjacent sibling selector */
        #blocks-container .gjs-block-category {
            /* We'll use JavaScript to hide the specific category */
        }
        
        /* Only allow Asset Manager in assets container */
        #assets-container .gjs-am-assets,
        #assets-container .gjs-am-container,
        #assets-container [class*="gjs-am"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            height: auto !important;
            width: auto !important;
            position: relative !important;
            left: auto !important;
        }
        
        /* ===== ASSETS PANEL STYLING ===== */
        #assets-panel.active {
            height: 100%;
            display: flex !important;
            flex-direction: column;
        }
        
        /* Simple Upload Button */
        .asset-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            justify-content: center;
        }
        
        .asset-upload-btn:hover {
            background: #7c3aed;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        
        .dark .asset-upload-btn {
            background: #7c3aed;
        }
        
        .dark .asset-upload-btn:hover {
            background: #6d28d9;
        }
        
        /* Upload Card in Grid */
        .asset-upload-card {
            aspect-ratio: 1;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9fafb;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .dark .asset-upload-card {
            background: #1f2937;
            border-color: #4b5563;
        }
        
        .asset-upload-card:hover {
            border-color: #8b5cf6;
            background: #f5f3ff;
        }
        
        .dark .asset-upload-card:hover {
            border-color: #8b5cf6;
            background: #2d1b69;
        }
        
        .asset-upload-btn-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            cursor: pointer;
            color: #8b5cf6;
        }
        
        .dark .asset-upload-btn-card {
            color: #a78bfa;
        }
        
        .asset-upload-btn-card:hover {
            color: #7c3aed;
        }
        
        .dark .asset-upload-btn-card:hover {
            color: #c4b5fd;
        }
        
        /* Old upload area - remove */
        .asset-upload-area {
            display: none;
        }
        
        /* ===== CUSTOM ASSET GRID ===== */
        .asset-grid-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            padding: 16px;
        }
        
        .asset-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        
        .asset-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f3f4f6;
            aspect-ratio: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .dark .asset-item {
            background: #374151;
        }
        
        .asset-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        
        .asset-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .asset-item-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .asset-item:hover .asset-item-overlay {
            opacity: 1;
        }
        
        .asset-item-name {
            color: white;
            font-size: 11px;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            margin-right: 8px;
        }
        
        /* Drag & Drop States */
        .asset-item[draggable="true"] {
            cursor: move;
        }
        
        .asset-item[draggable="true"]:hover {
            cursor: grab;
        }
        
        .asset-item[draggable="true"]:active {
            cursor: grabbing;
        }
        
        /* Canvas drag feedback */
        .gjs-cv-canvas.drag-over {
            outline: 2px dashed #667eea !important;
            background: rgba(102, 126, 234, 0.05) !important;
        }
        
        /* Drag preview (ghost image) */
        .asset-item-drag-preview {
            transform: scale(0.8);
            opacity: 0.8;
            border: 2px solid #667eea;
            border-radius: 8px;
        }
        
        /* ===== RESPONSIVE COLUMNS CSS ===== */
        
        /* Column responsive behavior */
        @media (max-width: 768px) {
            /* Make columns stack on mobile */
            div[style*="display: flex"] {
                flex-direction: column !important;
            }
            
            div[style*="display: flex"] > div {
                flex: 1 !important;
                width: 100% !important;
            }
        }
        
        /* Column drop zone styling */
        .column-dropzone {
            min-height: 120px;
            border: 2px dashed #e5e7eb;
            padding: 15px;
            background: #f8fafc;
            text-align: center;
            color: #6b7280;
            transition: all 0.2s ease;
        }
        
        .column-dropzone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .dark .column-dropzone {
            border-color: #374151;
            background: #111827;
            color: #9ca3af;
        }
        
        .dark .column-dropzone:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .asset-item-delete {
            background: rgba(239, 68, 68, 0.9);
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        
        .asset-item-delete:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        /* Empty State */
        .asset-empty-state {
            text-align: center;
            padding: 48px 24px;
        }
        
        .asset-empty-state i {
            display: block;
        }
        
        /* Loading State */
        .asset-loading-state {
            text-align: center;
            padding: 48px 24px;
        }
        
        .asset-loading-state i {
            display: block;
        }
        
        /* Assets container should take remaining space */
        #assets-container {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        #assets-panel .gjs-am-assets-cont {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        #assets-panel .gjs-am-assets-header {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            background: #f8fafc;
            flex-shrink: 0;
        }
        
        .dark #assets-panel .gjs-am-assets-header {
            border-bottom: 1px solid #374151;
            background: #111827;
        }
        
        /* Upload area styling */
        #assets-panel .gjs-am-file-uploader {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
            cursor: pointer;
        }
        
        .dark #assets-panel .gjs-am-file-uploader {
            border-color: #374151;
            background: #1f2937;
        }
        
        #assets-panel .gjs-am-file-uploader:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        #assets-panel .gjs-am-file-uploader div {
            color: #6b7280;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .dark #assets-panel .gjs-am-file-uploader div {
            color: #9ca3af;
        }
        
        /* Add Asset Button */
        #assets-panel .gjs-am-add-asset {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }
        
        #assets-panel .gjs-am-add-asset:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }
        
        /* Assets grid container */
        #assets-panel .gjs-am-assets {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            align-content: start;
        }
        
        /* Individual asset items */
        #assets-panel .gjs-am-asset {
            position: relative;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            aspect-ratio: 1;
        }
        
        .dark #assets-panel .gjs-am-asset {
            border-color: #374151;
            background: #1f2937;
        }
        
        #assets-panel .gjs-am-asset:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        /* Asset images */
        #assets-panel .gjs-am-asset-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        /* Asset metadata */
        #assets-panel .gjs-am-meta {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 6px;
            font-size: 10px;
            line-height: 1.2;
        }
        
        /* Empty state */
        #assets-panel .gjs-am-assets:empty::after {
            content: 'Chưa có ảnh nào. Kéo thả hoặc click để upload.';
            display: block;
            text-align: center;
            color: #6b7280;
            font-size: 14px;
            padding: 40px 20px;
            grid-column: 1 / -1;
        }
        
        .dark #assets-panel .gjs-am-assets:empty::after {
            color: #9ca3af;
        }
        
        .dark #assets-panel .gjs-am-meta {
            color: #9ca3af;
        }
        
        #assets-panel .gjs-am-close {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        #assets-panel .gjs-am-asset:hover .gjs-am-close {
            opacity: 1;
        }
        
        #assets-panel .gjs-am-close:hover {
            background: rgba(220, 38, 38, 1);
        }
        
        #assets-panel .gjs-am-preview-cont {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin: 12px;
            text-align: center;
        }
        
        .dark #assets-panel .gjs-am-preview-cont {
            background: #111827;
        }
        
        /* Drag & Drop Zone (main upload area, not in header) */
        #assets-panel .gjs-am-file-uploader:not(.gjs-am-assets-header .gjs-am-file-uploader) {
            border: 2px dashed #d1d5db !important;
            border-radius: 8px;
            padding: 40px 20px !important;
            text-align: center;
            background: #f9fafb !important;
            margin: 12px;
            transition: all 0.2s;
            min-width: auto !important;
        }
        
        .dark #assets-panel .gjs-am-file-uploader:not(.gjs-am-assets-header .gjs-am-file-uploader) {
            background: #111827 !important;
            border-color: #374151 !important;
        }
        
        #assets-panel .gjs-am-file-uploader:not(.gjs-am-assets-header .gjs-am-file-uploader):hover {
            border-color: #8b5cf6 !important;
            background: #f5f3ff !important;
        }
        
        .dark #assets-panel .gjs-am-file-uploader:not(.gjs-am-assets-header .gjs-am-file-uploader):hover {
            background: #1e1b4b !important;
        }
        
        #assets-panel #gjs-am-uploadFile {
            display: none !important;
        }
        
        /* Asset Select Button */
        #assets-panel .gjs-am-asset::after {
            content: 'Select';
            position: absolute;
            bottom: 35px;
            left: 50%;
            transform: translateX(-50%);
            background: #8b5cf6;
            color: white;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transition: all 0.2s;
            pointer-events: none;
            white-space: nowrap;
        }
        
        #assets-panel .gjs-am-asset:hover::after {
            opacity: 1;
        }
        
        /* Upload Form Styling */
        #assets-panel form {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .dark #assets-panel form {
            border-bottom-color: #374151;
        }
        
        #assets-panel input[type="file"] {
            display: none;
        }
        
        #assets-panel .gjs-btn-prim {
            background: #8b5cf6 !important;
            color: white !important;
            border: none !important;
            padding: 8px 16px !important;
            border-radius: 6px !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
        }
        
        #assets-panel .gjs-btn-prim:hover {
            background: #7c3aed !important;
            transform: translateY(-1px);
        }
        
        /* Empty state */
        #assets-panel .gjs-am-assets:empty::before {
            content: 'No assets yet. Click Upload to add images.';
            display: block;
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            font-size: 13px;
        }
        
        /* Responsive grid */
        @media (max-width: 400px) {
            #assets-panel .gjs-am-assets {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
        
        /* ===== CANVAS AREA ===== */
        #canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            margin: 0;
            padding: 10px;
            background: #f3f4f6;
            transition: all 0.3s ease;
        }
        
        .dark #canvas-area {
            background: #111827;
        }
        
        #gjs {
            flex: 1;
            position: relative;
            margin: 0;
            padding: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .dark #gjs {
            background: #1f2937;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* Canvas states for different sidebar combinations */
        #canvas-area.both-sidebars {
            padding: 10px;
        }
        
        #canvas-area.left-only {
            padding: 10px 10px 10px 10px;
        }
        
        #canvas-area.right-only {
            padding: 10px 10px 10px 10px;
        }
        
        #canvas-area.no-sidebars {
            padding: 10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* ===== EMPTY STATE ===== */
        .pagemaker-empty-state {
            animation: fadeInEmpty 0.5s ease-out;
        }
        
        @keyframes fadeInEmpty {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) translateY(10px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%) translateY(0);
            }
        }
        
        .pagemaker-empty-state svg {
            opacity: 0.7;
            margin-bottom: 16px;
        }
        
        .pagemaker-empty-state .tip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-block;
            margin-top: 16px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* ===== RIGHT PANEL (Styles + Properties) ===== */
        #right-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .dark #right-panel {
            background: #1f2937;
            border-left: 1px solid #374151;
        }
        
        /* Tabs for Styles & Properties */
        .right-panel-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .dark .right-panel-tabs {
            background: #111827;
            border-bottom: 1px solid #374151;
        }
        
        /* Left panel tabs - same style as right panel */
        .left-panel-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .dark .left-panel-tabs {
            background: #111827;
            border-bottom: 1px solid #374151;
        }
        
        .left-panel-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .left-panel-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .left-panel-tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }
        
        .dark .left-panel-tab.active {
            background: #1f2937;
        }
        
        /* Left panel content containers */
        .left-panel-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding: 12px;
        }
        
        .left-panel-content.active {
            display: block;
        }
        
        .right-panel-tab {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .right-panel-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .right-panel-tab.active {
            color: #667eea;
            background: white;
            border-bottom-color: #667eea;
        }
        
        .dark .right-panel-tab.active {
            background: #1f2937;
        }
        
        /* Close button for right panel */
        .right-panel-close {
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: #6b7280;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 1px solid #e5e7eb;
            margin-left: auto;
        }
        
        .dark .right-panel-close {
            color: #9ca3af;
            border-left-color: #374151;
        }
        
        .right-panel-close:hover {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }
        
        .dark .right-panel-close:hover {
            color: #f87171;
            background: rgba(239, 68, 68, 0.1);
        }
        
        /* Hide right panel state */
        #right-panel.hidden {
            display: none;
        }
        
        .right-panel-content {
            flex: 1;
            overflow-y: auto;
            display: none;
            padding: 12px;
        }
        
        .right-panel-content.active {
            display: block;
        }
        
        /* Style container inside right panel */
        #styles-tab #styles-container,
        #properties-tab #traits-container {
            padding: 0;
        }
        
        /* ===== PageMaker Custom Styles ===== */
        .gjs-one-bg {
            background-color: #f9fafb;
        }
        
        .dark .gjs-one-bg {
            background-color: #111827;
        }
        
        .gjs-two-color {
            color: #667eea;
        }
        
        .gjs-three-bg {
            background-color: #667eea;
            color: white;
        }
        
        .gjs-four-color,
        .gjs-four-color-h:hover {
            color: #667eea;
        }
        
        /* ✅ Hide PageMaker default panels/toolbars */
        .gjs-pn-panels {
            display: none !important;
        }
        
        .gjs-pn-devices-c {
            display: none !important;
        }
        
        .gjs-pn-views {
            display: none !important;
        }
        
        .gjs-pn-commands {
            display: none !important;
        }
        
        .gjs-pn-options {
            display: none !important;
        }
        
        /* Canvas full width/height - remove all gaps */
        .gjs-cv-canvas {
            width: 100% !important;
            height: 100% !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
        }
        
        .gjs-cv-canvas__frames {
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100% !important;
            height: 100% !important;
        }
        
        .gjs-frame {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* Toolbar styling - changed to blue background */
        .gjs-toolbar {
            background: #667eea !important;
            border: 1px solid #5568d3 !important;
            border-radius: 4px !important;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3) !important;
        }
        
        /* Toolbar buttons - ensure white icons on blue background */
        .gjs-toolbar .gjs-toolbar-item {
            color: white !important;
        }
        
        .gjs-toolbar .gjs-toolbar-item:hover {
            background: rgba(255, 255, 255, 0.2) !important;
        }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #10b981;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            animation: logoFloat 3s ease-in-out infinite;
        }
        
        .loading-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 12px;
            background: white;
            padding: 8px;
        }
        
        .spinner-container {
            position: relative;
            width: 80px;
            height: 80px;
            margin-bottom: 32px;
        }
        
        .spinner {
            width: 80px;
            height: 80px;
            border: 3px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1.2s linear infinite;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .spinner-inner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-bottom-color: #fff;
            animation: spin 0.8s linear infinite reverse;
            position: absolute;
            top: 10px;
            left: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        #loading-text {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .loading-subtitle {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Status Messages */
        .status-message {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            z-index: 10000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .status-message.success {
            background: #10b981;
        }
        
        .status-message.error {
            background: #ef4444;
        }
        
        .status-message.info {
            background: #3b82f6;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ===== FLOATING PREVIEW TOOLBAR ===== */
        #floating-preview-toolbar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            cursor: move;
            user-select: none;
        }
        
        .dark #floating-preview-toolbar {
            background: rgba(31, 41, 55, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Position classes for floating toolbar */
        #floating-preview-toolbar.position-top {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        #floating-preview-toolbar.position-left {
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
        }
        
        #floating-preview-toolbar.position-right {
            top: 50%;
            right: 20px;
            left: auto;
            transform: translateY(-50%);
        }
        
        #floating-preview-toolbar.position-bottom {
            bottom: 20px;
            top: auto;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .floating-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            background: #f3f4f6;
            color: #374151;
        }
        
        .dark .floating-btn {
            background: #374151;
            color: #f9fafb;
        }
        
        .floating-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .floating-btn-close {
            background: #ef4444;
            color: white;
            padding: 8px 10px;
        }
        
        .floating-btn-close:hover {
            background: #dc2626;
        }
        
        .floating-btn-save {
            background: #3b82f6;
            color: white;
        }
        
        .floating-btn-save:hover {
            background: #2563eb;
        }
        
        .floating-btn-publish {
            background: #10b981;
            color: white;
        }
        
        .floating-btn-publish:hover {
            background: #059669;
        }
        
        .floating-device-switcher {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .dark .floating-device-switcher {
            background: #1f2937;
            border: 1px solid #374151;
        }
        
        .floating-device-btn {
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .dark .floating-device-btn {
            color: #9ca3af;
        }
        
        .floating-device-btn:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .dark .floating-device-btn:hover {
            background: #374151;
            color: #f9fafb;
        }
        
        .floating-device-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .dark .floating-device-btn.active {
            background: #1f2937;
            color: #667eea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        /* Separator line */
        #floating-preview-toolbar::before {
            content: '';
            position: absolute;
            left: 50px;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 24px;
            background: #e5e7eb;
        }
        
        .dark #floating-preview-toolbar::before {
            background: #374151;
        }
        
        /* Hide Basic, Form, Extra categories by default */
        .gjs-block-category[data-category="Basic"],
        .gjs-block-category[data-category="Form"], 
        .gjs-block-category[data-category="Extra"] {
            display: none !important;
        }
        
        /* ===== ASSETS DRAG & DROP STYLING ===== */
        .drag-over {
            border: 2px dashed #667eea !important;
            background: rgba(102, 126, 234, 0.1) !important;
        }
        
        #assets-container .gjs-am-file-uploader {
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        #assets-container .gjs-am-file-uploader:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-logo">
            <img src="{{ url_for('static', filename='images/branding/logo.svg') }}" alt="PageMade">
        </div>
        
        <div class="spinner-container">
            <div class="spinner"></div>
            <div class="spinner-inner"></div>
        </div>
        
        <div id="loading-text">Đang khởi tạo PageMade Editor</div>
        <div class="loading-subtitle">Đang tải các công cụ thiết kế...</div>
    </div>
    
    <!-- Top Toolbar -->
    <div id="top-toolbar">
        <div class="left">
            <div class="logo-section">
                <img src="{{ url_for('static', filename='images/branding/logo.svg') }}" alt="PageMade" height="32">
            </div>
            
            <div class="page-info">
                <div class="page-title">{{ page.title }}</div>
                <div class="page-subtitle">{{ page.site.title }}</div>
            </div>
            
            <div class="device-switcher">
                <button class="device-btn active" data-device="Desktop" title="Tablet">
                    <i class="fas fa-tablet-alt"></i>
                </button>
                <button class="device-btn" data-device="Tablet" title="Desktop">
                    <i class="fas fa-desktop"></i>
                </button>
                <button class="device-btn" data-device="Mobile" title="Mobile">
                    <i class="fas fa-mobile-alt"></i>
                </button>
                
                <!-- Undo/Redo Buttons -->
                <div style="display: flex; gap: 4px; margin-left: 12px; padding-left: 12px; border-left: 1px solid #e5e7eb;" class="dark:border-gray-600">
                    <button class="device-btn" id="btn-undo" title="Hoàn tác (Ctrl+Z)" disabled>
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="device-btn" id="btn-redo" title="Làm lại (Ctrl+Y)" disabled>
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <!-- View Toggle Buttons -->
                <div style="display: flex; gap: 4px; margin-left: 12px; padding-left: 12px; border-left: 1px solid #e5e7eb;" class="dark:border-gray-600">
                    <button class="device-btn" id="btn-preview" title="Preview Mode">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="device-btn active" id="btn-outline" title="Component Outline">
                        <i class="fas fa-vector-square"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="right">
            <!-- Dark Mode Toggle -->
            <button id="darkModeToggle" 
                class="flex items-center justify-center text-black rounded-full cursor-pointer bg-gray-200 dark:bg-gray-800 h-9 w-9 dark:text-white transition-all duration-300 hover:bg-gray-300 dark:hover:bg-gray-700">
                <i class="fas fa-moon dark:hidden"></i>
                <i class="fas fa-sun hidden dark:block"></i>
            </button>
            
            <div class="lang-selector">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='15'%3E%3Crect fill='%23da251d' width='20' height='15'/%3E%3Cpolygon fill='%23ff0' points='10,4 11,7 14,7 11.5,9 12.5,12 10,10 7.5,12 8.5,9 6,7 9,7'/%3E%3C/svg%3E" width="20" height="15" alt="VN">
                <span>Tiếng Việt</span>
                <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
            </div>
            
            <button class="btn btn-save" id="btn-save">
                <i class="fas fa-save"></i>
                Lưu
            </button>
            
            <button class="btn btn-publish" id="btn-publish">
                Xuất bản
            </button>
        </div>
    </div>
    
    <!-- Main Editor -->
    <div id="editor-wrapper">
        <!-- Left Sidebar -->
        <div id="left-sidebar">
            <button class="sidebar-btn" data-panel="blocks" title="Blocks">
                <i class="fas fa-th-large"></i>
            </button>
            
            <button class="sidebar-btn" data-panel="layers" title="Layers">
                <i class="fas fa-layer-group"></i>
            </button>
            
            <button class="sidebar-btn" data-panel="assets" title="Assets">
                <i class="fas fa-images"></i>
            </button>
            
            <div style="flex: 1;"></div>
            
            <button class="sidebar-btn" data-panel="settings" title="Settings" style="display: none;">
                <i class="fas fa-cog"></i>
            </button>
            
            <button class="sidebar-btn" data-panel="help" title="Help" style="display: none;">
                <i class="fas fa-question-circle"></i>
            </button>
            
            <!-- Back Button -->
            <button class="sidebar-btn" onclick="window.location.href='{{ url_for('main.site_detail', site_id=page.site_id) }}'" title="Quay lại">
                <i class="fas fa-home"></i>
            </button>
        </div>
        
        <!-- Left Panel - Multiple Panels Support -->
        <div id="left-panel" class="active">
            
            <!-- Blocks Panel -->
            <div class="panel-section active" id="blocks-panel">
                <!-- Tabs Header -->
                <div class="left-panel-tabs">
                    <button class="left-panel-tab active" data-tab="site-blocks">
                        <i class="fas fa-th-large"></i> Site Blocks
                    </button>
                    <button class="left-panel-tab" data-tab="basic-blocks">
                        <i class="fas fa-cube"></i> Basic Blocks
                    </button>
                </div>
                
                <!-- Single container for ALL blocks -->
                <div class="left-panel-content active" id="blocks-container">
                    <!-- All blocks render here, filtered by CSS -->
                </div>
            </div>
            
            <!-- Layers Panel -->
            <div class="panel-section" id="layers-panel">
                <div class="panel-header">
                    <div class="panel-title">Layers</div>
                    <div class="panel-subtitle">Cấu trúc trang</div>
                </div>
                <div class="panel-content" id="layers-container">
                    <!-- GrapeJS Layer Manager will render here -->
                </div>
            </div>
            
            <!-- Assets Panel -->
            <div class="panel-section" id="assets-panel">
                <div class="panel-header">
                    <div class="panel-title">Assets</div>
                    <div class="panel-subtitle">Quản lý media</div>
                    <p style="font-size: 11px; color: #9ca3af; margin-top: 8px; margin-bottom: 12px;">
                        Hỗ trợ: JPG, PNG, GIF, WebP (Max 5MB)
                    </p>
                    
                    <!-- Upload Button -->
                    <input type="file" id="asset-file-input" accept="image/*" multiple style="display: none;">
                    <label for="asset-file-input" class="asset-upload-btn">
                        <i class="fas fa-upload"></i> Chọn file
                    </label>
                </div>
                
                <!-- Custom Asset Grid -->
                <div class="asset-grid-container" id="asset-grid-container">
                    <div class="asset-grid" id="user-assets-grid">
                        <!-- Asset items will be rendered here by JavaScript -->
                    </div>
                    
                    <!-- Empty State -->
                    <div class="asset-empty-state" id="asset-empty-state" style="display: none;">
                        <i class="fas fa-images" style="font-size: 48px; color: #9ca3af; margin-bottom: 16px;"></i>
                        <p style="font-size: 14px; color: #6b7280;">Chưa có asset nào</p>
                        <p style="font-size: 12px; color: #9ca3af;">Nhấn "Chọn file" để upload</p>
                    </div>
                    
                    <!-- Loading State -->
                    <div class="asset-loading-state" id="asset-loading-state" style="display: none;">
                        <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #8b5cf6;"></i>
                        <p style="font-size: 14px; color: #6b7280; margin-top: 12px;">Đang tải...</p>
                    </div>
                </div>
                
                <div class="panel-content" id="assets-container" style="display: none;">
                    <!-- GrapeJS Asset Manager (hidden, keeping for potential future use) -->
                </div>
            </div>
            
        </div>
        
        <!-- Canvas Area -->
        <div id="canvas-area">
            <div id="gjs"></div>
        </div>
        
        <!-- Right Panel (Styles + Properties with Tabs) -->
        <div id="right-panel">
            <div class="right-panel-tabs">
                <button class="right-panel-tab active" data-tab="styles">
                    <i class="fas fa-palette"></i> Styles
                </button>
                <button class="right-panel-tab" data-tab="properties">
                    <i class="fas fa-cog"></i> Properties
                </button>
                <button class="right-panel-close" id="right-panel-close" title="Đóng">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="right-panel-content active" id="styles-tab">
                <div id="styles-container">
                    <!-- PageMaker style manager will be injected here -->
                </div>
            </div>
            
            <div class="right-panel-content" id="properties-tab">
                <div id="traits-container">
                    <!-- PageMaker properties panel will be injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Preview Toolbar -->
    <div id="floating-preview-toolbar" style="display: none;">
        <!-- Close button -->
        <button id="floating-close" class="floating-btn floating-btn-close" title="Thoát Preview">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Device switcher -->
        <div class="floating-device-switcher">
            <button class="floating-device-btn active" data-device="Desktop" title="Desktop">
                <i class="fas fa-desktop"></i>
            </button>
            <button class="floating-device-btn" data-device="Tablet" title="Tablet">
                <i class="fas fa-tablet-alt"></i>
            </button>
            <button class="floating-device-btn" data-device="Mobile" title="Mobile">
                <i class="fas fa-mobile-alt"></i>
            </button>
        </div>
        
        <!-- Action buttons -->
        <button id="floating-save" class="floating-btn floating-btn-save" title="Lưu">
            <span>Lưu</span>
        </button>
        
        <button id="floating-publish" class="floating-btn floating-btn-publish" title="Xuất bản">
            <span>Xuất bản</span>
        </button>
    </div>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PageMaker Core Engine -->
    <script src="{{ url_for('static', filename='pagemaker/pagemaker.min.js') }}"></script>
    
    <!-- PageMaker Tailwind Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/grapesjs-tailwind@1/dist/grapesjs-tailwind.min.js"></script>
    
    <script>
        console.log('🚀 PageMaker Editor v2 initializing...');
        
        // ===== DARK MODE TOGGLE =====
        const darkModeToggle = document.getElementById('darkModeToggle');
        const html = document.documentElement;
        const currentTheme = localStorage.getItem('theme') || 'light';
        html.classList.toggle('dark', currentTheme === 'dark');
        darkModeToggle.addEventListener('click', () => {
            html.classList.toggle('dark');
            const newTheme = html.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', newTheme);
        });
        
        // ===== CANVAS RESPONSIVE LOGIC =====
        const canvasArea = document.getElementById('canvas-area');
        
        function updateCanvasLayout() {
            const leftPanelVisible = leftPanel.classList.contains('active');
            const rightPanelVisible = !rightPanel.classList.contains('hidden');
            
            // Remove all canvas state classes
            canvasArea.classList.remove('both-sidebars', 'left-only', 'right-only', 'no-sidebars');
            
            // Add appropriate class based on sidebar states
            if (leftPanelVisible && rightPanelVisible) {
                canvasArea.classList.add('both-sidebars');
            } else if (leftPanelVisible && !rightPanelVisible) {
                canvasArea.classList.add('left-only');
            } else if (!leftPanelVisible && rightPanelVisible) {
                canvasArea.classList.add('right-only');
            } else {
                canvasArea.classList.add('no-sidebars');
            }
        }
        
        // ===== LEFT SIDEBAR TOGGLE (Initialize before editor) =====
        const leftSidebar = document.getElementById('left-sidebar');
        const leftPanel = document.getElementById('left-panel');
        const sidebarButtons = leftSidebar.querySelectorAll('.sidebar-btn');
        const panelSections = document.querySelectorAll('.panel-section');
        
        // Store render states for each panel
        let currentActiveTab = 'site-blocks';
        let blocksRendered = false;
        let layersRendered = false;
        let assetsRendered = false;
        
        sidebarButtons.forEach((btn) => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const panelName = btn.getAttribute('data-panel');
                const isActive = btn.classList.contains('active');
                
                // If clicking same button - deactivate it
                if (isActive) {
                    btn.classList.remove('active');
                    leftPanel.classList.remove('active');
                } else {
                    // Activate new button and show corresponding panel
                    sidebarButtons.forEach(b => b.classList.remove('active'));
                    panelSections.forEach(p => p.classList.remove('active'));
                    
                    btn.classList.add('active');
                    leftPanel.classList.add('active');
                    
                    const targetPanel = document.getElementById(`${panelName}-panel`);
                    if (targetPanel) {
                        targetPanel.classList.add('active');
                    }
                    
                    // Handle Blocks panel
                    if (panelName === 'blocks' && window.editor && !blocksRendered) {
                        setTimeout(() => {
                            const blocksContainer = document.getElementById('blocks-container');
                            const blockManager = window.editor.BlockManager;
                            const blocksEl = blockManager.render();
                            
                            if (blocksContainer && blocksEl) {
                                blocksContainer.innerHTML = '';
                                blocksContainer.appendChild(blocksEl);
                                blocksRendered = true;
                                
                                // Apply initial filter
                                setTimeout(() => {
                                    if (window.filterBlocksByTab) {
                                        window.filterBlocksByTab(currentActiveTab);
                                    }
                                }, 100);
                            }
                        }, 50);
                    }
                    
                    // Handle Layers panel
                    if (panelName === 'layers' && window.editor && !layersRendered) {
                        setTimeout(() => {
                            const layersContainer = document.getElementById('layers-container');
                            const layerManager = window.editor.LayerManager;
                            const layersEl = layerManager.render();
                            
                            if (layersContainer && layersEl) {
                                layersContainer.innerHTML = '';
                                layersContainer.appendChild(layersEl);
                                layersRendered = true;
                                console.log('✅ Layers rendered');
                            }
                        }, 50);
                    }
                    
                    // Handle Assets panel
                    if (panelName === 'assets' && window.editor) {
                        // Always try to setup upload area when Assets panel opens
                        setTimeout(() => {
                            console.log('🎨 Assets panel opened, setting up upload...');
                            setupCustomUploadArea();
                        }, 100);
                        
                        // Load assets if not loaded yet
                        if (!window.assetsLoaded) {
                            setTimeout(() => {
                                loadUserAssets();
                                window.assetsLoaded = true;
                            }, 200);
                        }
                        
                        // Original asset manager rendering (only once)
                        if (!assetsRendered) {
                            setTimeout(() => {
                                const assetsContainer = document.getElementById('assets-container');
                                const assetManager = window.editor.AssetManager;
                                
                                if (assetsContainer && assetManager) {
                                    // Clear container
                                    assetsContainer.innerHTML = '';
                                    
                                    // Enable Asset Manager rendering for this specific call
                                    window.assetsRenderedInCorrectPlace = true;
                                    
                                    // Render with custom config
                                    const assetsEl = assetManager.render();
                                    
                                    if (assetsEl) {
                                        assetsContainer.appendChild(assetsEl);
                                        assetsRendered = true;
                                        console.log('✅ Assets rendered in correct place', assetManager);
                                        
                                        // Setup enhanced drag & drop
                                        setupAssetsDragDrop(assetsContainer, assetManager);
                                    } else {
                                        // If render failed, reset flag
                                        window.assetsRenderedInCorrectPlace = false;
                                    }
                                }
                            }, 50);
                        }
                    }
                }
                
                // Update canvas layout after sidebar toggle
                setTimeout(updateCanvasLayout, 100);
            });
        });
        

        
        // ===== RIGHT PANEL TABS (Initialize before editor) =====
        const rightPanelTabs = document.querySelectorAll('.right-panel-tab');
        const rightPanelContents = document.querySelectorAll('.right-panel-content');
        
        rightPanelTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Remove active from all tabs and contents
                rightPanelTabs.forEach(t => t.classList.remove('active'));
                rightPanelContents.forEach(c => c.classList.remove('active'));
                
                // Add active to clicked tab and corresponding content
                tab.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');
            });
        });
        
        // ===== LEFT PANEL TABS (Site Blocks / Basic Blocks) =====
        const leftPanelTabs = document.querySelectorAll('.left-panel-tab');
        
        // Categories for filtering
        const SITE_CATEGORIES = ['Blog', 'Contact', 'Content', 'CTA', 'Commerce', 'Features', 'Footer', 'Gallery', 'Header', 'Hero', 'Testimonials'];
        const BASIC_CATEGORIES = ['Basic', 'Form', 'Extra'];
        
        // Function to filter blocks by category
        function filterBlocksByTab(tabName) {
            const categories = tabName === 'site-blocks' ? SITE_CATEGORIES : BASIC_CATEGORIES;
            const blockCategories = document.querySelectorAll('#blocks-container .gjs-block-category');
            
            blockCategories.forEach(categoryEl => {
                const titleEl = categoryEl.querySelector('.gjs-title');
                if (!titleEl) return;
                
                const categoryName = titleEl.textContent.trim();
                const shouldShow = categories.includes(categoryName);
                
                categoryEl.style.display = shouldShow ? 'block' : 'none';
            });
            
            // Save current active tab
            currentActiveTab = tabName;
        }
        
        // Expose filter function globally
        window.filterBlocksByTab = filterBlocksByTab;
        
        leftPanelTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.getAttribute('data-tab');
                
                // Remove active from all tabs
                leftPanelTabs.forEach(t => t.classList.remove('active'));
                
                // Add active to clicked tab
                tab.classList.add('active');
                
                // Filter blocks
                filterBlocksByTab(tabName);
            });
        });
        
        // ===== PAGE DATA =====
        const PAGE_ID = {{ page.id }};
        const SITE_ID = {{ page.site_id }};
        const PAGE_TITLE = "{{ page.title }}";
        
        // API endpoints
        const LOAD_URL = `/api/pages/${PAGE_ID}/pagemaker/load`;
        const SAVE_URL = `/api/pages/${PAGE_ID}/pagemaker/save`;
        const PUBLISH_URL = `/api/pages/${PAGE_ID}/publish`;
        const PREVIEW_URL = `/api/pages/${PAGE_ID}/preview`;
        
        // Initialize PageMaker Editor
        const editor = pagemaker.init({
            container: '#gjs',
            height: '100%',
            width: 'auto',
            
            // ✅ Hide default panels and toolbars
            showOffsets: false,
            noticeOnUnload: false,
            
            // Storage Manager - Disabled (we handle save/load manually)
            storageManager: false,
            
            // Plugins
            plugins: ['grapesjs-tailwind'],
            pluginsOpts: {
                'grapesjs-tailwind': {
                    openCategory: 'Blog', // Default open category
                    loadBlocks: true, // Load all Tailwind blocks
                }
            },
            
            // Block Manager
            blockManager: {
                appendTo: '#blocks-container', // Render all blocks to single container
                custom: true,
            },
            
            // Style Manager - Complete CSS Properties
            styleManager: {
                appendTo: '#styles-container',
                sectors: [
                    {
                        name: 'Layout',
                        open: false,
                        buildProps: ['display', 'flex-direction', 'justify-content', 'align-items', 'align-content', 'flex-wrap', 'gap', 'float', 'clear', 'overflow', 'overflow-x', 'overflow-y'],
                        properties: [
                            {
                                type: 'select',
                                property: 'display',
                                default: 'block',
                                options: [
                                    { value: 'block', name: 'Block' },
                                    { value: 'inline', name: 'Inline' },
                                    { value: 'inline-block', name: 'Inline Block' },
                                    { value: 'flex', name: 'Flex' },
                                    { value: 'inline-flex', name: 'Inline Flex' },
                                    { value: 'grid', name: 'Grid' },
                                    { value: 'inline-grid', name: 'Inline Grid' },
                                    { value: 'none', name: 'None' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'flex-direction',
                                default: 'row',
                                options: [
                                    { value: 'row', name: 'Row' },
                                    { value: 'row-reverse', name: 'Row Reverse' },
                                    { value: 'column', name: 'Column' },
                                    { value: 'column-reverse', name: 'Column Reverse' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'justify-content',
                                default: 'flex-start',
                                options: [
                                    { value: 'flex-start', name: 'Start' },
                                    { value: 'center', name: 'Center' },
                                    { value: 'flex-end', name: 'End' },
                                    { value: 'space-between', name: 'Space Between' },
                                    { value: 'space-around', name: 'Space Around' },
                                    { value: 'space-evenly', name: 'Space Evenly' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'align-items',
                                default: 'stretch',
                                options: [
                                    { value: 'stretch', name: 'Stretch' },
                                    { value: 'flex-start', name: 'Start' },
                                    { value: 'center', name: 'Center' },
                                    { value: 'flex-end', name: 'End' },
                                    { value: 'baseline', name: 'Baseline' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'flex-wrap',
                                default: 'nowrap',
                                options: [
                                    { value: 'nowrap', name: 'No Wrap' },
                                    { value: 'wrap', name: 'Wrap' },
                                    { value: 'wrap-reverse', name: 'Wrap Reverse' },
                                ],
                            },
                        ]
                    },
                    {
                        name: 'Size',
                        open: false,
                        buildProps: ['width', 'height', 'max-width', 'min-width', 'max-height', 'min-height'],
                        properties: [
                            {
                                property: 'width',
                                type: 'integer',
                                units: ['px', '%', 'vw', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'height',
                                type: 'integer',
                                units: ['px', '%', 'vh', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'max-width',
                                type: 'integer',
                                units: ['px', '%', 'vw', 'em', 'rem', 'none'],
                                default: 'none',
                            },
                            {
                                property: 'min-width',
                                type: 'integer',
                                units: ['px', '%', 'vw', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'max-height',
                                type: 'integer',
                                units: ['px', '%', 'vh', 'em', 'rem', 'none'],
                                default: 'none',
                            },
                            {
                                property: 'min-height',
                                type: 'integer',
                                units: ['px', '%', 'vh', 'em', 'rem'],
                                default: '0',
                            },
                        ]
                    },
                    {
                        name: 'Space',
                        open: false,
                        buildProps: ['margin-top', 'margin-right', 'margin-bottom', 'margin-left', 'padding-top', 'padding-right', 'padding-bottom', 'padding-left'],
                        properties: [
                            {
                                property: 'margin-top',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'margin-right',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'margin-bottom',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'margin-left',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: '0',
                            },
                            {
                                property: 'padding-top',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'padding-right',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'padding-bottom',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'padding-left',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                        ]
                    },
                    {
                        name: 'Position',
                        open: false,
                        buildProps: ['position', 'top', 'right', 'bottom', 'left', 'z-index'],
                        properties: [
                            {
                                type: 'select',
                                property: 'position',
                                default: 'static',
                                options: [
                                    { value: 'static', name: 'Static' },
                                    { value: 'relative', name: 'Relative' },
                                    { value: 'absolute', name: 'Absolute' },
                                    { value: 'fixed', name: 'Fixed' },
                                    { value: 'sticky', name: 'Sticky' },
                                ],
                            },
                            {
                                property: 'top',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'right',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'bottom',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'left',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem', 'auto'],
                                default: 'auto',
                            },
                            {
                                property: 'z-index',
                                type: 'integer',
                                default: 'auto',
                            },
                        ]
                    },
                    {
                        name: 'Typography',
                        open: false,
                        buildProps: ['font-family', 'font-size', 'font-weight', 'font-style', 'line-height', 'letter-spacing', 'word-spacing', 'text-align', 'text-decoration', 'text-transform', 'color', 'text-shadow'],
                        properties: [
                            {
                                property: 'font-family',
                                type: 'select',
                                default: 'inherit',
                                options: [
                                    { value: 'inherit', name: 'Inherit' },
                                    { value: 'Arial, sans-serif', name: 'Arial' },
                                    { value: 'Helvetica, sans-serif', name: 'Helvetica' },
                                    { value: 'Georgia, serif', name: 'Georgia' },
                                    { value: '"Times New Roman", serif', name: 'Times New Roman' },
                                    { value: '"Courier New", monospace', name: 'Courier New' },
                                    { value: 'Verdana, sans-serif', name: 'Verdana' },
                                    { value: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif', name: 'System Font' },
                                ],
                            },
                            {
                                property: 'font-size',
                                type: 'integer',
                                units: ['px', 'em', 'rem', '%', 'pt'],
                                default: '16px',
                            },
                            {
                                type: 'select',
                                property: 'font-weight',
                                default: '400',
                                options: [
                                    { value: '100', name: 'Thin (100)' },
                                    { value: '200', name: 'Extra Light (200)' },
                                    { value: '300', name: 'Light (300)' },
                                    { value: '400', name: 'Normal (400)' },
                                    { value: '500', name: 'Medium (500)' },
                                    { value: '600', name: 'Semi Bold (600)' },
                                    { value: '700', name: 'Bold (700)' },
                                    { value: '800', name: 'Extra Bold (800)' },
                                    { value: '900', name: 'Black (900)' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'font-style',
                                default: 'normal',
                                options: [
                                    { value: 'normal', name: 'Normal' },
                                    { value: 'italic', name: 'Italic' },
                                    { value: 'oblique', name: 'Oblique' },
                                ],
                            },
                            {
                                property: 'line-height',
                                type: 'integer',
                                units: ['', 'px', 'em', 'rem', '%'],
                                default: 'normal',
                            },
                            {
                                property: 'letter-spacing',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: 'normal',
                            },
                            {
                                type: 'select',
                                property: 'text-align',
                                default: 'left',
                                options: [
                                    { value: 'left', name: 'Left' },
                                    { value: 'center', name: 'Center' },
                                    { value: 'right', name: 'Right' },
                                    { value: 'justify', name: 'Justify' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'text-decoration',
                                default: 'none',
                                options: [
                                    { value: 'none', name: 'None' },
                                    { value: 'underline', name: 'Underline' },
                                    { value: 'overline', name: 'Overline' },
                                    { value: 'line-through', name: 'Line Through' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'text-transform',
                                default: 'none',
                                options: [
                                    { value: 'none', name: 'None' },
                                    { value: 'uppercase', name: 'UPPERCASE' },
                                    { value: 'lowercase', name: 'lowercase' },
                                    { value: 'capitalize', name: 'Capitalize' },
                                ],
                            },
                            {
                                property: 'color',
                                type: 'color',
                                default: '#000000',
                            },
                            {
                                property: 'text-shadow',
                                type: 'stack',
                                default: 'none',
                            },
                        ]
                    },
                    {
                        name: 'Background',
                        open: false,
                        buildProps: ['background-color', 'background-image', 'background-size', 'background-position', 'background-repeat', 'background-attachment'],
                        properties: [
                            {
                                property: 'background-color',
                                type: 'color',
                                default: 'transparent',
                            },
                            {
                                property: 'background-image',
                                type: 'file',
                                default: 'none',
                            },
                            {
                                type: 'select',
                                property: 'background-size',
                                default: 'auto',
                                options: [
                                    { value: 'auto', name: 'Auto' },
                                    { value: 'cover', name: 'Cover' },
                                    { value: 'contain', name: 'Contain' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'background-position',
                                default: 'left top',
                                options: [
                                    { value: 'left top', name: 'Left Top' },
                                    { value: 'center top', name: 'Center Top' },
                                    { value: 'right top', name: 'Right Top' },
                                    { value: 'left center', name: 'Left Center' },
                                    { value: 'center center', name: 'Center Center' },
                                    { value: 'right center', name: 'Right Center' },
                                    { value: 'left bottom', name: 'Left Bottom' },
                                    { value: 'center bottom', name: 'Center Bottom' },
                                    { value: 'right bottom', name: 'Right Bottom' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'background-repeat',
                                default: 'repeat',
                                options: [
                                    { value: 'repeat', name: 'Repeat' },
                                    { value: 'repeat-x', name: 'Repeat X' },
                                    { value: 'repeat-y', name: 'Repeat Y' },
                                    { value: 'no-repeat', name: 'No Repeat' },
                                ],
                            },
                            {
                                type: 'select',
                                property: 'background-attachment',
                                default: 'scroll',
                                options: [
                                    { value: 'scroll', name: 'Scroll' },
                                    { value: 'fixed', name: 'Fixed' },
                                    { value: 'local', name: 'Local' },
                                ],
                            },
                        ]
                    },
                    {
                        name: 'Borders',
                        open: false,
                        buildProps: ['border-top-width', 'border-right-width', 'border-bottom-width', 'border-left-width', 'border-style', 'border-color', 'border-top-left-radius', 'border-top-right-radius', 'border-bottom-right-radius', 'border-bottom-left-radius'],
                        properties: [
                            {
                                property: 'border-top-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-right-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-bottom-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-left-width',
                                type: 'integer',
                                units: ['px', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                type: 'select',
                                property: 'border-style',
                                default: 'solid',
                                options: [
                                    { value: 'none', name: 'None' },
                                    { value: 'solid', name: 'Solid' },
                                    { value: 'dotted', name: 'Dotted' },
                                    { value: 'dashed', name: 'Dashed' },
                                    { value: 'double', name: 'Double' },
                                    { value: 'groove', name: 'Groove' },
                                    { value: 'ridge', name: 'Ridge' },
                                    { value: 'inset', name: 'Inset' },
                                    { value: 'outset', name: 'Outset' },
                                ],
                            },
                            {
                                property: 'border-color',
                                type: 'color',
                                default: '#000000',
                            },
                            {
                                property: 'border-top-left-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-top-right-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-bottom-right-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                            {
                                property: 'border-bottom-left-radius',
                                type: 'integer',
                                units: ['px', '%', 'em', 'rem'],
                                default: '0',
                            },
                        ]
                    },
                    {
                        name: 'Effects',
                        open: false,
                        buildProps: ['opacity', 'box-shadow', 'transform', 'transition', 'cursor', 'filter'],
                        properties: [
                            {
                                property: 'opacity',
                                type: 'slider',
                                default: '1',
                                min: 0,
                                max: 1,
                                step: 0.01,
                            },
                            {
                                property: 'box-shadow',
                                type: 'stack',
                                default: 'none',
                            },
                            {
                                property: 'transform',
                                type: 'stack',
                                default: 'none',
                            },
                            {
                                property: 'transition',
                                type: 'stack',
                                default: 'none',
                            },
                            {
                                type: 'select',
                                property: 'cursor',
                                default: 'auto',
                                options: [
                                    { value: 'auto', name: 'Auto' },
                                    { value: 'default', name: 'Default' },
                                    { value: 'pointer', name: 'Pointer' },
                                    { value: 'text', name: 'Text' },
                                    { value: 'move', name: 'Move' },
                                    { value: 'not-allowed', name: 'Not Allowed' },
                                    { value: 'grab', name: 'Grab' },
                                    { value: 'grabbing', name: 'Grabbing' },
                                ],
                            },
                            {
                                property: 'filter',
                                type: 'stack',
                                default: 'none',
                            },
                        ]
                    }
                ],
            },
            
            // Layer Manager
            layerManager: {
                appendTo: '#layers-container',
            },
            
            // Asset Manager - DISABLED auto appendTo, we'll handle manually
            assetManager: {
                // appendTo: '#assets-container', // REMOVED - we control rendering manually
                upload: '/api/assets/upload',
                uploadName: 'file',
                multiUpload: false, // Single file upload for better control
                autoAdd: true,
                // Custom buttons text
                uploadText: 'Kéo thả file vào đây hoặc click để upload',
                addBtnText: '+ Thêm ảnh',
                // Enable search/filter
                showUrlInput: true,
                modalTitle: 'Chọn ảnh',
                // Custom text
                noAssets: 'Chưa có ảnh nào',
                // Additional config
                credentials: 'same-origin',
                // Restrict rendering to only Assets container
                custom: true,
                params: {
                    site_id: SITE_ID
                },
                // Custom upload handler
                uploadFile: async function(e) {
                    try {
                        const files = e.dataTransfer ? e.dataTransfer.files : e.target.files;
                        
                        // Process each file
                        for (let file of files) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('site_id', SITE_ID);
                            
                            // Show upload progress
                            showStatus(`Đang tải lên ${file.name}...`, 'info');
                            
                            const response = await fetch('/api/assets/upload', {
                                method: 'POST',
                                body: formData,
                                credentials: 'same-origin'
                            });
                            
                            const data = await response.json();
                            
                            if (data.success && data.asset) {
                                // Add to asset manager
                                editor.AssetManager.add({
                                    id: data.asset.id,
                                    src: data.asset.url,
                                    name: data.asset.original_name,
                                    type: 'image',
                                    width: data.asset.width,
                                    height: data.asset.height
                                });
                                
                                showStatus(`Tải lên thành công: ${file.name}`, 'success');
                            } else {
                                throw new Error(data.error || 'Upload failed');
                            }
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        showStatus(`Lỗi tải lên: ${error.message}`, 'error');
                    }
                }
            },
            
            // Trait Manager
            traitManager: {
                appendTo: '#traits-container',
            },
            
            // Canvas settings
            canvas: {
                styles: [],
                scripts: [],
            },
            
            // Device Manager
            deviceManager: {
                devices: [
                    {
                        name: 'Desktop',
                        width: '',
                    },
                    {
                        name: 'Tablet',
                        width: '768px',
                        widthMedia: '992px',
                    },
                    {
                        name: 'Mobile',
                        width: '320px',
                        widthMedia: '480px',
                    }
                ]
            },
        });
        
        // Expose editor to window for debugging and panel toggle
        window.editor = editor;
        console.log('✅ Editor initialized');
        
        // ===== CANVAS DRAG & DROP FUNCTIONALITY =====
        
        // Setup canvas drop zone after editor loads
        editor.on('load', () => {
            setTimeout(() => {
                setupCanvasDropZone();
                disableDefaultAssetDrop();
            }, 1000);
        });
        
        // Disable GrapesJS default asset drag & drop behavior
        function disableDefaultAssetDrop() {
            console.log('🚫 Disabling GrapesJS default asset drop...');
            
            // Override Canvas drag methods
            const canvas = editor.Canvas;
            
            // Block canvas dragover and drop events from GrapesJS
            const originalOnDragOver = canvas.onDragOver;
            const originalOnDrop = canvas.onDrop;
            
            canvas.onDragOver = function(e) {
                // Check if this is our custom drag
                const assetUrl = e.dataTransfer.getData('text/asset-url');
                if (assetUrl) {
                    // This is our custom drag - do nothing, let our handler deal with it
                    e.preventDefault();
                    return;
                }
                // Otherwise, call original GrapesJS handler
                if (originalOnDragOver) {
                    originalOnDragOver.call(this, e);
                }
            };
            
            canvas.onDrop = function(e) {
                // Check if this is our custom drag
                const assetUrl = e.dataTransfer.getData('text/asset-url');
                if (assetUrl) {
                    // This is our custom drag - prevent GrapesJS from handling
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🚫 Blocked GrapesJS drop handler for custom asset');
                    return;
                }
                // Otherwise, call original GrapesJS handler
                if (originalOnDrop) {
                    originalOnDrop.call(this, e);
                }
            };
            
            console.log('✅ GrapesJS drag handlers overridden');
        }
        
        function setupCanvasDropZone() {
            const canvasBody = editor.Canvas.getBody();
            const canvasFrame = editor.Canvas.getFrameEl();
            
            if (!canvasBody || !canvasFrame) {
                console.warn('⚠️ Canvas not ready for drop zone setup, retrying...');
                setTimeout(setupCanvasDropZone, 500);
                return;
            }
            
            console.log('🎯 Setting up canvas drop zone...');
            
            // Get canvas container element
            const canvasContainer = editor.Canvas.getElement();
            
            // Prevent default drag behaviors on canvas
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                canvasBody.addEventListener(eventName, preventDefaults, false);
                if (canvasContainer) {
                    canvasContainer.addEventListener(eventName, preventDefaults, false);
                }
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // Add visual feedback during drag
            ['dragenter', 'dragover'].forEach(eventName => {
                canvasBody.addEventListener(eventName, () => {
                    if (canvasContainer) {
                        canvasContainer.style.backgroundColor = 'rgba(102, 126, 234, 0.1)';
                        canvasContainer.style.outline = '2px dashed #667eea';
                    }
                });
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                canvasBody.addEventListener(eventName, () => {
                    if (canvasContainer) {
                        canvasContainer.style.backgroundColor = '';
                        canvasContainer.style.outline = '';
                    }
                });
            });
            
            // Handle drop event
            canvasBody.addEventListener('drop', (e) => {
                console.log('🎯 Asset dropped on canvas');
                
                // CRITICAL: Stop ALL event propagation immediately
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                
                // Get asset data from drag transfer
                const assetUrl = e.dataTransfer.getData('text/asset-url');
                const assetName = e.dataTransfer.getData('text/asset-name');
                const assetId = e.dataTransfer.getData('text/asset-id');
                
                if (!assetUrl) {
                    console.log('❌ No asset data in drop event - this might be a GrapesJS default drop');
                    return false; // Explicitly return false
                }
                
                // Clear dataTransfer to prevent any further processing
                e.dataTransfer.clearData();
                
                console.log('✅ Processing custom asset drop:', assetName);
                
                // Get drop position relative to canvas
                const canvasRect = canvasBody.getBoundingClientRect();
                const dropX = e.clientX - canvasRect.left;
                const dropY = e.clientY - canvasRect.top;
                
                console.log(`📍 Drop position: (${dropX}, ${dropY})`);
                
                // Find target component at drop position
                let targetComponent = null;
                const targetElement = e.target;
                
                if (targetElement && targetElement !== canvasBody) {
                    // Walk up the DOM to find a GrapesJS component
                    let current = targetElement;
                    while (current && current !== canvasBody) {
                        // Check if this element corresponds to a GrapesJS component
                        const wrapper = editor.getWrapper();
                        const allComponents = [];
                        
                        // Recursively collect all components
                        function collectComponents(comp) {
                            allComponents.push(comp);
                            comp.components().each(child => collectComponents(child));
                        }
                        
                        collectComponents(wrapper);
                        
                        // Find matching component
                        targetComponent = allComponents.find(comp => comp.getEl() === current);
                        
                        if (targetComponent) break;
                        current = current.parentElement;
                    }
                }
                
                if (targetComponent && (targetComponent.get('tagName') === 'div' || 
                                       targetComponent.get('tagName') === 'section' || 
                                       targetComponent.get('tagName') === 'main' ||
                                       targetComponent.get('type') === 'wrapper')) {
                    // Drop into container
                    const newImage = targetComponent.append({
                        type: 'image',
                        src: assetUrl,
                        attributes: { alt: assetName },
                        style: {
                            'max-width': '100%',
                            'height': 'auto',
                            'display': 'block'
                        }
                    })[0];
                    
                    editor.select(newImage);
                    showStatus(`✅ Đã thêm ảnh vào container: ${assetName}`, 'success');
                    console.log('✅ Image added to target container via drag & drop');
                    return false;
                }
                
                // Add to canvas with absolute positioning
                addImageAtPosition(assetUrl, assetName, dropX, dropY);
                return false; // Prevent any further event processing
            }, true); // Use capture phase to intercept before GrapesJS
            
            console.log('✅ Canvas drop zone ready');
        }
        
        // Helper function to add image at specific position
        function addImageAtPosition(assetUrl, assetName, x, y) {
            try {
                // Remove any placeholder images that might have been created
                setTimeout(() => {
                    const placeholderImages = editor.getWrapper().find('image').filter(img => {
                        const src = img.get('src') || img.getEl()?.src;
                        return !src || src.includes('placeholder') || src.includes('data:image');
                    });
                    
                    placeholderImages.forEach(placeholder => {
                        console.log('🗑️ Removing placeholder image:', placeholder.get('src'));
                        placeholder.remove();
                    });
                }, 100);
                
                const newImage = editor.addComponents({
                    type: 'image',
                    src: assetUrl,
                    attributes: { alt: assetName },
                    style: {
                        'position': 'absolute',
                        'left': Math.max(0, x - 100) + 'px', // Center image on cursor
                        'top': Math.max(0, y - 50) + 'px',
                        'max-width': '200px',
                        'height': 'auto',
                        'z-index': '1'
                    }
                })[0];
                
                if (newImage) {
                    editor.select(newImage);
                    showStatus(`✅ Đã thêm ảnh tại vị trí: ${assetName}`, 'success');
                    console.log(`✅ Image positioned at (${x}, ${y}) via drag & drop`);
                } else {
                    console.error('❌ Failed to create image component');
                    showStatus(`❌ Lỗi khi thêm ảnh: ${assetName}`, 'error');
                }
            } catch (error) {
                console.error('❌ Error adding image at position:', error);
                showStatus(`❌ Lỗi khi thêm ảnh: ${error.message}`, 'error');
            }
        }
        
        // ===== ENSURE ASSET MANAGER ONLY RENDERS IN ASSETS PANEL =====
        // Override ALL Asset Manager rendering methods
        const originalAssetManagerRender = editor.AssetManager.render;
        const originalAssetManagerGetContainer = editor.AssetManager.getContainer;
        
        // Override main render method
        editor.AssetManager.render = function() {
            if (window.assetsRenderedInCorrectPlace !== true) {
                console.log('🚫 Asset Manager render blocked - not in assets panel context');
                return null;
            }
            
            console.log('✅ Authorized Asset Manager render');
            const result = originalAssetManagerRender.call(this);
            
            // Reset flag after successful render to prevent unauthorized future renders
            setTimeout(() => {
                window.assetsRenderedInCorrectPlace = false;
            }, 100);
            
            return result;
        };
        
        // Also override getContainer to prevent auto-appending
        editor.AssetManager.getContainer = function() {
            if (window.assetsRenderedInCorrectPlace !== true) {
                console.log('🚫 Asset Manager getContainer blocked');
                return null;
            }
            return originalAssetManagerGetContainer.call(this);
        };
        
        // Add mutation observer to remove any unauthorized Asset Manager UI elements only
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // Remove ONLY Asset Manager UI components from blocks and layers containers
                        const blocksContainer = document.getElementById('blocks-container');
                        const layersContainer = document.getElementById('layers-container');
                        
                        if (blocksContainer) {
                            // Only remove specific GrapesJS Asset Manager UI elements
                            const assetUIElements = blocksContainer.querySelectorAll('.gjs-am-assets, .gjs-am-file-uploader, .gjs-am-assets-cont');
                            assetUIElements.forEach(el => {
                                console.log('🚫 Removing Asset Manager UI from blocks:', el);
                                el.remove();
                            });
                        }
                        
                        if (layersContainer) {
                            // Only remove specific GrapesJS Asset Manager UI elements
                            const assetUIElements = layersContainer.querySelectorAll('.gjs-am-assets, .gjs-am-file-uploader, .gjs-am-assets-cont');
                            assetUIElements.forEach(el => {
                                console.log('🚫 Removing Asset Manager UI from layers:', el);
                                el.remove();
                            });
                        }
                    }
                });
            });
        });
        
        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // Also do initial cleanup after blocks are loaded
        setTimeout(() => {
            const blocksContainer = document.getElementById('blocks-container');
            const layersContainer = document.getElementById('layers-container');
            
            [blocksContainer, layersContainer].forEach(container => {
                if (container) {
                    // Only hide specific Asset Manager UI elements
                    const assetUIElements = container.querySelectorAll('.gjs-am-assets, .gjs-am-file-uploader, .gjs-am-assets-cont');
                    assetUIElements.forEach(el => {
                        console.log('🚫 Initial cleanup - hiding Asset Manager UI:', el);
                        el.style.display = 'none';
                    });
                }
            });
            
            // Hide block category titled "Assets"
            if (blocksContainer) {
                const blockCategories = blocksContainer.querySelectorAll('.gjs-block-category');
                blockCategories.forEach(category => {
                    const titleEl = category.querySelector('.gjs-title, .gjs-block-category-title');
                    if (titleEl) {
                        const titleText = titleEl.textContent || titleEl.innerText || '';
                        if (titleText.toLowerCase().includes('asset')) {
                            console.log('🚫 Hiding Assets block category:', titleText);
                            category.style.display = 'none';
                        }
                    }
                });
            }
        }, 2000);
        
        console.log('✅ Using PageMaker Tailwind plugin blocks');
        
        // ===== Empty State Management =====
        
        function checkEmptyState() {
            const canvas = editor.Canvas.getDocument();
            const body = canvas.querySelector('body');
            const hasContent = body && body.children.length > 0;
            
            if (!hasContent) {
                showEmptyState();
            } else {
                hideEmptyState();
            }
        }
        
        function showEmptyState() {
            const canvas = editor.Canvas.getDocument();
            const body = canvas.querySelector('body');
            
            if (body && !body.querySelector('.pagemaker-empty-state')) {
                body.innerHTML = `
                    <div class="pagemaker-empty-state" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        text-align: center;
                        color: #64748b;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        pointer-events: none;
                        z-index: 1000;
                        max-width: 400px;
                        padding: 40px 20px;
                    ">
                        <div style="margin-bottom: 32px;">
                            <div style="
                                width: 120px;
                                height: 80px;
                                background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
                                border: 2px dashed #cbd5e1;
                                border-radius: 12px;
                                margin: 0 auto 20px auto;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                position: relative;
                            ">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <polyline points="21,15 16,10 5,21"/>
                                </svg>
                                
                                <!-- Floating plus icon -->
                                <div style="
                                    position: absolute;
                                    bottom: -8px;
                                    right: -8px;
                                    width: 24px;
                                    height: 24px;
                                    background: #667eea;
                                    border-radius: 50%;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
                                ">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                                        <line x1="12" y1="5" x2="12" y2="19"></line>
                                        <line x1="5" y1="12" x2="19" y2="12"></line>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        
                        <h3 style="
                            font-size: 28px;
                            font-weight: 700;
                            margin: 0 0 16px 0;
                            color: #1f2937;
                            line-height: 1.2;
                        ">
                            Bắt đầu xây dựng trang của bạn!
                        </h3>
                        
                        <p style="
                            font-size: 16px;
                            margin: 0 0 32px 0;
                            color: #6b7280;
                            line-height: 1.5;
                        ">
                            Kéo và thả các blocks từ sidebar bên trái để tạo nội dung chuyên nghiệp
                        </p>
                        
                        <div style="
                            display: inline-flex;
                            align-items: center;
                            gap: 12px;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 14px 24px;
                            border-radius: 25px;
                            font-size: 14px;
                            font-weight: 500;
                            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
                            margin-bottom: 20px;
                        ">
                            <span style="font-size: 16px;">✨</span>
                            <span>Thử bắt đầu với Hero Block</span>
                        </div>
                        
                        <div style="
                            font-size: 13px;
                            color: #9ca3af;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                        ">
                            <span>💡</span>
                            <span>Hoặc chọn từ thư viện Tailwind Components</span>
                        </div>
                    </div>
                `;
            }
        }
        
        function hideEmptyState() {
            const canvas = editor.Canvas.getDocument();
            const emptyState = canvas.querySelector('.pagemaker-empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }
        
        // Monitor canvas changes
        editor.on('component:add component:remove', () => {
            setTimeout(checkEmptyState, 100);
        });
        
        // Flag to prevent auto-save during initial load
        let isInitialLoad = true;
        
        // Initial load - Load saved content from API
        editor.on('load', async () => {
            try {
                const response = await fetch(LOAD_URL);
                const data = await response.json();
                
                // Load content into editor
                if (data['gjs-html'] || data['gjs-css'] || (data['gjs-components'] && data['gjs-components'].length > 0)) {
                    // PRIORITY: Load components if available (preserves structure)
                    if (data['gjs-components'] && data['gjs-components'].length > 0) {
                        editor.setComponents(data['gjs-components']);
                        editor.setStyle(data['gjs-styles'] || data['gjs-css'] || '');
                    } else {
                        // Fallback to HTML/CSS only if no components
                        editor.setComponents(data['gjs-html'] || '');
                        editor.setStyle(data['gjs-css'] || '');
                    }
                    console.log('✅ Content loaded');
                }
                
                // Disable initial load flag after 3 seconds
                setTimeout(() => {
                    isInitialLoad = false;
                }, 3000);
                
            } catch (error) {
                console.error('❌ Load error:', error);
            }
            
            setTimeout(checkEmptyState, 500);
            
            // Set default device to Desktop
            editor.setDevice('Desktop');
            
            // Initialize view toggles
            setTimeout(() => {
                // Set initial state for outline (active by default)
                editor.runCommand('core:component-outline');
            }, 500);
            
            // ===== AUTO RENDER BLOCKS on page load =====
            setTimeout(() => {
                const blocksBtn = document.querySelector('.sidebar-btn[data-panel="blocks"]');
                const blocksContainer = document.getElementById('blocks-container');
                const leftPanel = document.getElementById('left-panel');
                
                if (blocksBtn && blocksContainer && leftPanel) {
                    // Show left panel using class
                    leftPanel.classList.add('active');
                    blocksBtn.classList.add('active');
                    
                    // Render blocks
                    const blockManager = editor.BlockManager;
                    const blocksEl = blockManager.render();
                    
                    if (blocksEl) {
                        blocksContainer.innerHTML = '';
                        blocksContainer.appendChild(blocksEl);
                        console.log('✅ Blocks rendered');
                    }
                    
                    // Update canvas layout after initial load
                    setTimeout(updateCanvasLayout, 100);
                }
            }, 1000);
            
            // ===== Load Block Systems =====
            
            let allBlocksLoaded = false;
            
            // Function to hide basic categories immediately when they appear
            function hideBasicCategories() {
                const blockCategories = document.querySelectorAll('#blocks-container .gjs-block-category');
                blockCategories.forEach(categoryEl => {
                    const titleEl = categoryEl.querySelector('.gjs-title');
                    if (!titleEl) return;
                    
                    const categoryName = titleEl.textContent.trim();
                    if (['Basic', 'Form', 'Extra'].includes(categoryName)) {
                        categoryEl.style.display = 'none';
                    }
                });
            }
            
            // Set up MutationObserver to hide categories as soon as they're added
            const blocksContainer = document.getElementById('blocks-container');
            if (blocksContainer) {
                const observer = new MutationObserver(() => {
                    hideBasicCategories();
                });
                observer.observe(blocksContainer, { childList: true, subtree: true });
            }
            
            // 1. Load Site Blocks (custom-blocks)
            import('/static/pagemaker/custom-blocks/index.js')
                .then(module => {
                    module.default(editor);
                    console.log('✅ Site Blocks System loaded');
                    // Hide basic categories immediately after site blocks load
                    setTimeout(hideBasicCategories, 100);
                })
                .catch(err => {
                    console.warn('⚠️ Site Blocks not available:', err);
                });
            
            // 2. Load Basic Blocks System
            import('/static/pagemaker/basic-blocks/index.js')
                .then(module => {
                    module.default(editor);
                    console.log('✅ Basic Blocks System loaded');
                    
                    // Hide basic categories immediately after basic blocks load
                    setTimeout(hideBasicCategories, 100);
                    
                    // After all blocks loaded, apply initial filter
                    setTimeout(() => {
                        allBlocksLoaded = true;
                        filterBlocksByTab('site-blocks'); // Show Site Blocks by default
                        console.log('✅ Initial filter applied');
                        
                        // Load existing assets
                        loadExistingAssets();
                    }, 500);
                })
                .catch(err => {
                    console.error('❌ Failed to load Basic Blocks:', err);
                });
        });
        
        // ===== ASSETS MANAGEMENT =====
        
        function setupCustomUploadArea() {
            const fileInput = document.getElementById('asset-file-input');
            const uploadLabel = document.querySelector('label[for="asset-file-input"]');
            
            if (!fileInput) {
                console.error('⚠️ File input not found! DOM not ready yet.');
                return;
            }
            
            if (!uploadLabel) {
                console.error('⚠️ Upload label not found!');
                return;
            }
            
            // Prevent duplicate event listeners
            if (fileInput.dataset.listenerAttached === 'true') {
                console.log('ℹ️ Upload handler already attached');
                return;
            }
            
            console.log('✅ Setting up upload handler...', {
                fileInputId: fileInput.id,
                labelFor: uploadLabel.getAttribute('for')
            });
            
            // Debug: Test label click
            uploadLabel.addEventListener('click', (e) => {
                console.log('🖱️ Label clicked!', {
                    target: e.target,
                    fileInputId: fileInput.id,
                    willTriggerFileInput: uploadLabel.getAttribute('for') === fileInput.id
                });
            });
            
            // Handle file input change
            fileInput.addEventListener('change', async (e) => {
                console.log('🎯 File input change event triggered!');
                const files = e.target.files;
                if (files && files.length > 0) {
                    console.log(`📦 Processing ${files.length} file(s)...`);
                    await uploadFiles(files);
                    fileInput.value = ''; // Reset for re-upload
                } else {
                    console.log('⚠️ No files selected');
                }
            });
            
            // Mark as attached
            fileInput.dataset.listenerAttached = 'true';
            console.log('✅ Upload handler ready!');
        }
        
        async function uploadFiles(files) {
            for (let file of files) {
                // Validate file
                if (!file.type.startsWith('image/')) {
                    showStatus(`❌ ${file.name} không phải là file ảnh`, 'error');
                    continue;
                }
                
                if (file.size > 5 * 1024 * 1024) {
                    showStatus(`❌ ${file.name} quá lớn (max 5MB)`, 'error');
                    continue;
                }
                
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    formData.append('site_id', SITE_ID);
                    
                    showStatus(`📤 Đang tải lên...`, 'info');
                    
                    const response = await fetch('/api/assets/upload', {
                        method: 'POST',
                        body: formData,
                        credentials: 'same-origin'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success && data.asset) {
                        // Show success notification
                        showStatus(`✅ Ảnh được tải lên thành công`, 'success');
                        
                        // Reload asset grid to show new upload
                        console.log('🔄 Reloading asset grid...');
                        await loadUserAssets();
                    } else {
                        showStatus(`❌ ${data.error || 'Upload failed'}`, 'error');
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showStatus(`❌ Lỗi khi upload`, 'error');
                }
            }
        }
        
        function setupAssetsDragDrop(container, assetManager) {
            // Enhanced drag & drop support
            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.add('drag-over');
            });
            
            container.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.remove('drag-over');
            });
            
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                container.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const uploadFn = assetManager.getConfig().uploadFile;
                    if (uploadFn) {
                        uploadFn.call(assetManager, e);
                    }
                }
            });
        }
        
        // ===== CUSTOM ASSET GRID FUNCTIONS =====
        
        async function loadUserAssets() {
            try {
                console.log('🖼️ Loading user assets...');
                
                // Show loading state
                const loadingState = document.getElementById('asset-loading-state');
                const emptyState = document.getElementById('asset-empty-state');
                const assetGrid = document.getElementById('user-assets-grid');
                
                if (loadingState) loadingState.style.display = 'block';
                if (emptyState) emptyState.style.display = 'none';
                if (assetGrid) assetGrid.style.display = 'none';
                
                const response = await fetch(`/api/assets/${SITE_ID}`, {
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide loading state
                if (loadingState) loadingState.style.display = 'none';
                
                if (data.success && data.assets && data.assets.length > 0) {
                    console.log(`✅ Loaded ${data.assets.length} user assets`);
                    renderAssetGrid(data.assets);
                } else {
                    // Show empty state
                    console.log('📭 No assets found');
                    if (assetGrid) assetGrid.style.display = 'none';
                    if (emptyState) emptyState.style.display = 'block';
                }
                
            } catch (error) {
                console.error('❌ Failed to load user assets:', error);
                const loadingState = document.getElementById('asset-loading-state');
                if (loadingState) loadingState.style.display = 'none';
                showStatus('❌ Không thể tải assets', 'error');
            }
        }
        
        function renderAssetGrid(assets) {
            const grid = document.getElementById('user-assets-grid');
            const emptyState = document.getElementById('asset-empty-state');
            
            if (!grid) return;
            
            // Clear grid
            grid.innerHTML = '';
            grid.style.display = 'grid';
            if (emptyState) emptyState.style.display = 'none';
            
            // Render each asset
            assets.forEach(asset => {
                const item = document.createElement('div');
                item.className = 'asset-item';
                item.dataset.assetId = asset.id;
                item.dataset.assetUrl = asset.url;
                item.dataset.assetName = asset.original_name;
                
                // Truncate filename
                const displayName = truncateFilename(asset.original_name, 15);
                
                item.innerHTML = `
                    <img src="${asset.url}" alt="${asset.original_name}" loading="lazy">
                    <div class="asset-item-overlay">
                        <span class="asset-item-name" title="${asset.original_name}">${displayName}</span>
                        <button class="asset-item-delete" data-asset-id="${asset.id}" title="Xóa">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // Add tooltip for drag & drop
                item.title = `${asset.original_name}\n\nClick để thêm vào canvas\nKéo thả để đặt tại vị trí cụ thể`;
                
                // Make item draggable
                item.draggable = true;
                
                // Drag event handlers
                item.addEventListener('dragstart', (e) => {
                    console.log(`🎯 Started dragging: ${asset.original_name}`);
                    
                    // IMPORTANT: Prevent GrapesJS from handling this drag
                    e.stopPropagation();
                    
                    // Store ONLY our asset data, clear any other data
                    e.dataTransfer.clearData();
                    e.dataTransfer.setData('text/asset-url', asset.url);
                    e.dataTransfer.setData('text/asset-name', asset.original_name);
                    e.dataTransfer.setData('text/asset-id', asset.id);
                    e.dataTransfer.effectAllowed = 'copy';
                    
                    // Create small drag preview image
                    const dragPreview = document.createElement('div');
                    dragPreview.style.cssText = `
                        width: 80px;
                        height: 80px;
                        background: white;
                        border: 2px solid #667eea;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                        position: fixed;
                        top: -1000px;
                        left: -1000px;
                        z-index: 9999;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        overflow: hidden;
                    `;
                    
                    const previewImg = document.createElement('img');
                    previewImg.src = asset.url;
                    previewImg.style.cssText = `
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                        border-radius: 6px;
                    `;
                    
                    dragPreview.appendChild(previewImg);
                    document.body.appendChild(dragPreview);
                    
                    // Set the custom drag image
                    e.dataTransfer.setDragImage(dragPreview, 40, 40);
                    
                    // Remove the preview element after drag starts
                    setTimeout(() => {
                        if (dragPreview.parentNode) {
                            dragPreview.parentNode.removeChild(dragPreview);
                        }
                    }, 0);
                    
                    // Add drag visual feedback to original item
                    item.style.opacity = '0.5';
                });
                
                item.addEventListener('dragend', (e) => {
                    // Reset visual feedback
                    item.style.opacity = '1';
                });
                
                // Click to select asset (insert into canvas) - kept for backward compatibility
                item.addEventListener('click', (e) => {
                    // Don't trigger if clicking delete button or if dragging
                    if (e.target.closest('.asset-item-delete')) return;
                    
                    selectAsset(asset.id, asset.url, asset.original_name);
                });
                
                // Delete button handler
                const deleteBtn = item.querySelector('.asset-item-delete');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteAsset(asset.id, asset.original_name);
                });
                
                grid.appendChild(item);
            });
            
            console.log(`✅ Rendered ${assets.length} assets in grid with drag & drop`);
        }
        
        function selectAsset(assetId, assetUrl, assetName) {
            console.log(`🎯 Asset selected: ${assetName}`);
            
            // Smart behavior based on selection
            const selected = editor.getSelected();
            
            if (selected && selected.is('image')) {
                // Case 1: Image component selected → Replace src
                selected.addAttributes({ src: assetUrl, alt: assetName });
                showStatus(`✅ Đã cập nhật ảnh: ${assetName}`, 'success');
                console.log('✅ Updated selected image component');
                
            } else if (selected && selected.get('tagName') === 'div') {
                // Case 2: Container selected → Add image inside
                const newImage = selected.append({
                    type: 'image',
                    src: assetUrl,
                    attributes: { alt: assetName },
                    style: {
                        'max-width': '100%',
                        'height': 'auto',
                        'display': 'block'
                    }
                })[0];
                
                // Select the newly added image
                editor.select(newImage);
                showStatus(`✅ Đã thêm ảnh vào container: ${assetName}`, 'success');
                console.log('✅ Added image to selected container');
                
            } else if (selected) {
                // Case 3: Other component selected → Add to parent
                const parent = selected.parent();
                if (parent && parent !== editor.getWrapper()) {
                    const newImage = parent.append({
                        type: 'image',
                        src: assetUrl,
                        attributes: { alt: assetName },
                        style: {
                            'max-width': '100%',
                            'height': 'auto',
                            'display': 'block'
                        }
                    })[0];
                    
                    editor.select(newImage);
                    showStatus(`✅ Đã thêm ảnh vào parent container: ${assetName}`, 'success');
                    console.log('✅ Added image to parent of selected component');
                } else {
                    // Fallback to canvas root
                    addImageToCanvas(assetUrl, assetName);
                }
                
            } else {
                // Case 4: Nothing selected → Add to canvas center
                addImageToCanvas(assetUrl, assetName);
            }
        }
        
        // Helper function to add image to canvas
        function addImageToCanvas(assetUrl, assetName) {
            const wrapper = editor.getWrapper();
            const newImage = editor.addComponents({
                type: 'image',
                src: assetUrl,
                attributes: { alt: assetName },
                style: {
                    'max-width': '100%',
                    'height': 'auto',
                    'display': 'block',
                    'margin': '10px auto'
                }
            })[0];
            
            // Select the newly added image
            editor.select(newImage);
            
            showStatus(`✅ Đã thêm ảnh vào canvas: ${assetName}`, 'success');
            console.log('✅ Added new image to canvas');
        }
        
        async function deleteAsset(assetId, assetName) {
            if (!confirm(`Xóa asset "${assetName}"?\n\nHành động này không thể hoàn tác.`)) {
                return;
            }
            
            try {
                console.log(`🗑️ Deleting asset: ${assetName}`);
                
                const response = await fetch(`/api/assets/${assetId}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showStatus(`✅ Đã xóa: ${assetName}`, 'success');
                    console.log('✅ Asset deleted successfully');
                    
                    // Reload asset grid
                    await loadUserAssets();
                } else {
                    showStatus(`❌ ${data.error || 'Không thể xóa asset'}`, 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                showStatus(`❌ Lỗi khi xóa asset`, 'error');
            }
        }
        
        function truncateFilename(filename, maxLength = 15) {
            if (filename.length <= maxLength) return filename;
            
            const dotIndex = filename.lastIndexOf('.');
            if (dotIndex === -1) {
                // No extension
                return filename.substring(0, maxLength - 3) + '...';
            }
            
            const ext = filename.substring(dotIndex);
            const nameWithoutExt = filename.substring(0, dotIndex);
            const truncatedName = nameWithoutExt.substring(0, maxLength - ext.length - 3) + '...';
            
            return truncatedName + ext;
        }
        
        // Legacy function - keep for compatibility
        async function loadExistingAssets() {
            // Now just calls the new function
            await loadUserAssets();
        }
        
        // ===== RIGHT PANEL TOGGLE LOGIC =====
        const rightPanel = document.getElementById('right-panel');
        const rightPanelClose = document.getElementById('right-panel-close');
        let isRightPanelVisible = true; // Start visible
        
        // Close button functionality
        rightPanelClose.addEventListener('click', () => {
            rightPanel.classList.add('hidden');
            isRightPanelVisible = false;
            // Update canvas layout after hiding right panel
            setTimeout(updateCanvasLayout, 100);
        });
        
        // Function to show right panel
        function showRightPanel() {
            if (!isRightPanelVisible) {
                rightPanel.classList.remove('hidden');
                isRightPanelVisible = true;
                // Update canvas layout after showing right panel
                setTimeout(updateCanvasLayout, 100);
            }
        }
        
        // ===== Auto-switch to Styles when component selected =====
        editor.on('component:selected', (component) => {
            // Show right panel when component is selected
            showRightPanel();
            
            // Auto switch to Styles tab when user selects a component
            const stylesTab = document.querySelector('.right-panel-tab[data-tab="styles"]');
            if (stylesTab) {
                stylesTab.click(); // Trigger click to switch to Styles tab
            }
        });
        
        // Hide right panel when clicking on canvas (no component selected)
        editor.on('component:deselected', () => {
            // Optional: hide panel when deselecting component
            // Comment out if you want panel to stay visible
            // rightPanel.classList.add('hidden');
            // isRightPanelVisible = false;
        });
        
        // ===== UI Controls =====
        
        // Device Switcher
        document.querySelectorAll('.device-btn[data-device]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.device-btn[data-device]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                const device = btn.dataset.device;
                editor.setDevice(device);
            });
        });
        
        // View Toggle Commands
        editor.Commands.add('toggle-preview', {
            run: (editor, sender) => {
                const isActive = sender.classList.contains('active');
                
                if (isActive) {
                    // Exit preview mode
                    sender.classList.remove('active');
                    document.body.classList.remove('preview-mode');
                    
                    // Show all elements
                    const elementsToShow = [
                        '#top-toolbar',
                        '#left-sidebar', 
                        '#left-panel',
                        '#right-panel'
                    ];
                    
                    elementsToShow.forEach(selector => {
                        const el = document.querySelector(selector);
                        if (el) el.style.display = '';
                    });
                    
                    // Reset canvas area
                    const canvasArea = document.getElementById('canvas-area');
                    if (canvasArea) {
                        canvasArea.style.cssText = '';
                    }
                    
                } else {
                    // Enter preview mode
                    sender.classList.add('active');
                    document.body.classList.add('preview-mode');
                    
                    // Hide all panels
                    const elementsToHide = [
                        '#top-toolbar',
                        '#left-sidebar',
                        '#left-panel', 
                        '#right-panel'
                    ];
                    
                    elementsToHide.forEach(selector => {
                        const el = document.querySelector(selector);
                        if (el) el.style.display = 'none';
                    });
                    
                    // Make canvas full screen
                    const canvasArea = document.getElementById('canvas-area');
                    if (canvasArea) {
                        canvasArea.style.cssText = `
                            position: fixed !important;
                            top: 0 !important;
                            left: 0 !important;
                            width: 100vw !important;
                            height: 100vh !important;
                            z-index: 9999 !important;
                            background: white !important;
                            padding: 0 !important;
                            margin: 0 !important;
                        `;
                    }
                }
            }
        });
        
        editor.Commands.add('toggle-outline', {
            run: (editor, sender) => {
                const isActive = editor.Commands.isActive('core:component-outline');
                if (isActive) {
                    editor.stopCommand('core:component-outline');
                    sender.classList.remove('active');
                } else {
                    editor.runCommand('core:component-outline');
                    sender.classList.add('active');
                }
            }
        });
        

        
        // View Toggle Button Handlers
        document.getElementById('btn-preview').addEventListener('click', function() {
            const btn = this;
            const isActive = btn.classList.contains('active');
            
            if (isActive) {
                // Exit preview mode
                btn.classList.remove('active');
                document.body.classList.remove('preview-mode');
                
                // Hide floating toolbar
                const floatingToolbar = document.getElementById('floating-preview-toolbar');
                if (floatingToolbar) {
                    floatingToolbar.style.display = 'none';
                }
                
                // Show all elements
                const elementsToShow = [
                    '#top-toolbar',
                    '#left-sidebar', 
                    '#left-panel',
                    '#right-panel'
                ];
                
                elementsToShow.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = '';
                });
                
                // Reset canvas area
                const canvasArea = document.getElementById('canvas-area');
                if (canvasArea) {
                    canvasArea.style.cssText = '';
                }
                
            } else {
                // Enter preview mode
                btn.classList.add('active');
                document.body.classList.add('preview-mode');
                
                // Hide all panels
                const elementsToHide = [
                    '#top-toolbar',
                    '#left-sidebar',
                    '#left-panel', 
                    '#right-panel'
                ];
                
                elementsToHide.forEach(selector => {
                    const el = document.querySelector(selector);
                    if (el) el.style.display = 'none';
                });
                
                // Make canvas full screen
                const canvasArea = document.getElementById('canvas-area');
                if (canvasArea) {
                    canvasArea.style.cssText = `
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100vw !important;
                        height: 100vh !important;
                        z-index: 9999 !important;
                        background: white !important;
                        padding: 0 !important;
                        margin: 0 !important;
                    `;
                }
                
                // Show floating toolbar
                const floatingToolbar = document.getElementById('floating-preview-toolbar');
                if (floatingToolbar) {
                    floatingToolbar.style.display = 'flex';
                    
                    // Sync device switcher state
                    setTimeout(syncFloatingDeviceSwitcher, 100);
                }
            }
        });
        
        document.getElementById('btn-outline').addEventListener('click', function() {
            const btn = this;
            const isActive = btn.classList.contains('active');
            
            if (isActive) {
                editor.stopCommand('core:component-outline');
                btn.classList.remove('active');
            } else {
                editor.runCommand('core:component-outline');
                btn.classList.add('active');
            }
        });
        

        
        // ===== FLOATING TOOLBAR FUNCTIONALITY =====
        
        // Close button functionality
        document.getElementById('floating-close').addEventListener('click', () => {
            // Trigger exit preview mode
            const previewBtn = document.getElementById('btn-preview');
            if (previewBtn && previewBtn.classList.contains('active')) {
                previewBtn.click();
            }
        });
        
        // Floating device switcher functionality
        document.querySelectorAll('.floating-device-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active from all floating device buttons
                document.querySelectorAll('.floating-device-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Also update main device switcher
                const device = btn.dataset.device;
                const mainDeviceBtn = document.querySelector(`.device-btn[data-device="${device}"]`);
                if (mainDeviceBtn) {
                    document.querySelectorAll('.device-btn[data-device]').forEach(b => b.classList.remove('active'));
                    mainDeviceBtn.classList.add('active');
                }
                
                // Set device in editor
                editor.setDevice(device);
            });
        });
        
        // Sync floating device switcher with main device switcher
        function syncFloatingDeviceSwitcher() {
            const activeMainBtn = document.querySelector('.device-btn[data-device].active');
            if (activeMainBtn) {
                const device = activeMainBtn.dataset.device;
                const floatingBtn = document.querySelector(`.floating-device-btn[data-device="${device}"]`);
                if (floatingBtn) {
                    document.querySelectorAll('.floating-device-btn').forEach(b => b.classList.remove('active'));
                    floatingBtn.classList.add('active');
                }
            }
        }
        
        // Update floating device switcher when main device switcher changes
        document.querySelectorAll('.device-btn[data-device]').forEach(btn => {
            btn.addEventListener('click', () => {
                setTimeout(syncFloatingDeviceSwitcher, 50);
            });
        });
        
        // Show status message
        function showStatus(message, type = 'success') {
            const statusEl = document.createElement('div');
            statusEl.className = `status-message ${type}`;
            statusEl.textContent = message;
            document.body.appendChild(statusEl);
            
            setTimeout(() => {
                statusEl.remove();
            }, 3000);
        }
        
        // Auto-save function (reusable)
        async function autoSaveContent() {
            try {
                console.log('💾 Auto-saving content...');
                
                // Get current editor state
                const html = editor.getHtml();
                const css = editor.getCss();
                const projectData = editor.getProjectData();
                
                // Prepare save data
                const saveData = {
                    'gjs-html': html,
                    'gjs-css': css,
                    'gjs-components': projectData.pages?.[0]?.frames?.[0]?.component?.components || [],
                    'gjs-styles': projectData.styles || [],
                    'gjs-assets': projectData.assets || []
                };
                
                // Send to API
                const response = await fetch(SAVE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Auto-save response:', result);
                return result;
            } catch (error) {
                console.error('❌ Auto-save error:', error);
                throw error;
            }
        }

        // Save button - Custom save implementation
        document.getElementById('btn-save').addEventListener('click', async () => {
            try {
                console.log('💾 Saving content...');
                
                const result = await autoSaveContent();
                showStatus('Đã lưu thành công!', 'success');
            } catch (error) {
                console.error('❌ Save error:', error);
                showStatus('Lỗi khi lưu: ' + error.message, 'error');
            }
        });
        
        // Floating save button functionality
        document.getElementById('floating-save').addEventListener('click', async () => {
            const btn = document.getElementById('floating-save');
            const originalContent = btn.innerHTML;
            
            try {
                // Show loading state
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Đang lưu...</span>';
                btn.disabled = true;
                
                console.log('💾 Floating save content...');
                
                const result = await autoSaveContent();
                
                // Show success state
                btn.innerHTML = '<i class="fas fa-check"></i><span>Đã lưu!</span>';
                btn.style.background = '#10b981';
                
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('❌ Floating save error:', error);
                
                // Show error state
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Lỗi!</span>';
                btn.style.background = '#ef4444';
                
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 3000);
            }
        });

        // ===== UNDO/REDO FUNCTIONALITY =====
        
        const btnUndo = document.getElementById('btn-undo');
        const btnRedo = document.getElementById('btn-redo');
        
        // Function to update button states
        function updateUndoRedoButtons() {
            const um = editor.UndoManager;
            
            // Update Undo button
            if (um.hasUndo()) {
                btnUndo.disabled = false;
            } else {
                btnUndo.disabled = true;
            }
            
            // Update Redo button
            if (um.hasRedo()) {
                btnRedo.disabled = false;
            } else {
                btnRedo.disabled = true;
            }
        }
        
        // Undo button click handler
        btnUndo.addEventListener('click', () => {
            if (editor.UndoManager.hasUndo()) {
                editor.UndoManager.undo();
                console.log('↶ Undo executed');
            }
        });
        
        // Redo button click handler
        btnRedo.addEventListener('click', () => {
            if (editor.UndoManager.hasRedo()) {
                editor.UndoManager.redo();
                console.log('↷ Redo executed');
            }
        });
        
        // Keyboard shortcuts for Undo/Redo
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z or Cmd+Z for Undo
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                if (editor.UndoManager.hasUndo()) {
                    editor.UndoManager.undo();
                    console.log('⌨️ Undo via keyboard (Ctrl+Z)');
                }
            }
            
            // Ctrl+Y or Cmd+Shift+Z for Redo
            if ((e.ctrlKey || e.metaKey) && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) {
                e.preventDefault();
                if (editor.UndoManager.hasRedo()) {
                    editor.UndoManager.redo();
                    console.log('⌨️ Redo via keyboard (Ctrl+Y / Ctrl+Shift+Z)');
                }
            }
        });
        
        // Listen to editor changes to update button states
        editor.on('load', () => {
            updateUndoRedoButtons();
        });
        
        editor.on('update', () => {
            updateUndoRedoButtons();
        });
        
        // Also listen to undo/redo events
        editor.on('undo', () => {
            updateUndoRedoButtons();
        });
        
        editor.on('redo', () => {
            updateUndoRedoButtons();
        });
        
        // Initial state
        updateUndoRedoButtons();
        
        console.log('✅ Undo/Redo initialized');

        
        // Publish button
        // Publish button
        document.getElementById('btn-publish').addEventListener('click', async () => {
            if (!confirm('Xuất bản trang này lên subdomain? Trang sẽ truy cập được công khai.')) {
                return;
            }
            
            try {
                showStatus('Đang lưu và xuất bản...', 'info');
                
                // Step 1: Save content first (same as Save button)
                console.log('Saving before publish...');
                
                const html = editor.getHtml();
                const css = editor.getCss();
                const projectData = editor.getProjectData();
                
                const saveData = {
                    'gjs-html': html,
                    'gjs-css': css,
                    'gjs-components': projectData.pages?.[0]?.frames?.[0]?.component?.components || [],
                    'gjs-styles': projectData.styles || [],
                    'gjs-assets': projectData.assets || []
                };
                
                const saveResponse = await fetch(SAVE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });
                
                if (!saveResponse.ok) {
                    throw new Error('Không thể lưu nội dung');
                }
                
                console.log('✅ Content saved, now publishing...');
                
                // Step 2: Publish to subdomain
                const publishResponse = await fetch(PUBLISH_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const result = await publishResponse.json();
                
                if (result.success) {
                    showStatus(`Xuất bản thành công! Mở ${result.subdomain}.pagemade.site...`, 'success');
                    console.log('🚀 Published to:', result.url);
                    
                    // Open published site in new tab
                    setTimeout(() => {
                        window.open(result.url, '_blank');
                    }, 1500);
                } else {
                    showStatus('Lỗi: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('❌ Publish error:', error);
                showStatus('Lỗi khi xuất bản: ' + error.message, 'error');
            }
        });
        
        // Floating publish button functionality
        document.getElementById('floating-publish').addEventListener('click', async () => {
            const btn = document.getElementById('floating-publish');
            const originalContent = btn.innerHTML;
            
            if (!confirm('Xuất bản trang này lên subdomain? Trang sẽ truy cập được công khai.')) {
                return;
            }
            
            try {
                // Show loading state
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Đang xuất bản...</span>';
                btn.disabled = true;
                
                console.log('🚀 Floating publish content...');
                
                // Step 1: Save content first
                const html = editor.getHtml();
                const css = editor.getCss();
                const projectData = editor.getProjectData();
                
                const saveData = {
                    'gjs-html': html,
                    'gjs-css': css,
                    'gjs-components': projectData.pages?.[0]?.frames?.[0]?.component?.components || [],
                    'gjs-styles': projectData.styles || [],
                    'gjs-assets': projectData.assets || []
                };
                
                const saveResponse = await fetch(SAVE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(saveData)
                });
                
                if (!saveResponse.ok) {
                    throw new Error('Không thể lưu nội dung');
                }
                
                console.log('✅ Content saved, now publishing...');
                
                // Step 2: Publish to subdomain
                const publishResponse = await fetch(PUBLISH_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
                
                const result = await publishResponse.json();
                
                if (result.success) {
                    // Show success state
                    btn.innerHTML = '<i class="fas fa-check"></i><span>Thành công!</span>';
                    btn.style.background = '#10b981';
                    
                    console.log('🚀 Published to:', result.url);
                    
                    // Open published site in new tab
                    setTimeout(() => {
                        window.open(result.url, '_blank');
                        
                        // Reset button after opening
                        setTimeout(() => {
                            btn.innerHTML = originalContent;
                            btn.style.background = '';
                            btn.disabled = false;
                        }, 1000);
                    }, 1500);
                    
                } else {
                    throw new Error(result.message || 'Lỗi khi xuất bản');
                }
                
            } catch (error) {
                console.error('❌ Floating publish error:', error);
                
                // Show error state
                btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i><span>Lỗi!</span>';
                btn.style.background = '#ef4444';
                
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 3000);
            }
        });
        
        // Hide loading when ready
        editor.on('load', () => {
            console.log('✅ PageMaker Editor loaded!');
            
            setTimeout(() => {
                const loadingOverlay = document.getElementById('loading-overlay');
                loadingOverlay.style.opacity = '0';
                loadingOverlay.style.transition = 'opacity 0.5s ease';
                
                setTimeout(() => {
                    loadingOverlay.remove();
                }, 500);
            }, 1000);
        });
        
        // Auto-save every 2 minutes (skip during initial load)
        setInterval(() => {
            if (isInitialLoad) {
                console.log('⏭️ Skipping auto-save during initial load');
                return;
            }
            console.log('💾 Auto-saving...');
            document.getElementById('btn-save').click();
        }, 2 * 60 * 1000);
        
        console.log('✅ PageMaker Editor v2 initialized');
        
        // ===== FLOATING TOOLBAR DRAGGABLE FUNCTIONALITY =====
        
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let toolbarStartX = 0;
        let toolbarStartY = 0;
        
        const floatingToolbar = document.getElementById('floating-preview-toolbar');
        
        // Save/load position from localStorage
        function saveToolbarPosition(position) {
            try {
                localStorage.setItem('floatingToolbarPosition', position);
            } catch (e) {
                console.warn('Could not save toolbar position to localStorage:', e);
            }
        }
        
        function getToolbarPosition() {
            try {
                return localStorage.getItem('floatingToolbarPosition') || 'top';
            } catch (e) {
                console.warn('Could not read toolbar position from localStorage:', e);
                return 'top';
            }
        }
        
        // Apply position class
        function setToolbarPosition(position) {
            // Remove all position classes
            floatingToolbar.classList.remove('position-top', 'position-left', 'position-right', 'position-bottom');
            
            // Add new position class
            floatingToolbar.classList.add(`position-${position}`);
            
            // Save position
            saveToolbarPosition(position);
        }
        
        // Calculate snap position based on drag end
        function calculateSnapPosition(x, y) {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const toolbarRect = floatingToolbar.getBoundingClientRect();
            
            const centerX = windowWidth / 2;
            const centerY = windowHeight / 2;
            
            const toolbarCenterX = x + toolbarRect.width / 2;
            const toolbarCenterY = y + toolbarRect.height / 2;
            
            // Determine which edge is closest
            const distances = {
                top: Math.abs(toolbarCenterY - 100), // 100px from top
                bottom: Math.abs(toolbarCenterY - (windowHeight - 100)), // 100px from bottom
                left: Math.abs(toolbarCenterX - 100), // 100px from left
                right: Math.abs(toolbarCenterX - (windowWidth - 100)) // 100px from right
            };
            
            const minDistance = Math.min(...Object.values(distances));
            const closestEdge = Object.keys(distances).find(key => distances[key] === minDistance);
            
            return closestEdge;
        }
        
        // Mouse down - start dragging
        floatingToolbar.addEventListener('mousedown', (e) => {
            // Only allow dragging on the toolbar itself, not on buttons or their children
            if (e.target.closest('.floating-btn') || 
                e.target.closest('.floating-device-btn') ||
                e.target.closest('.floating-device-switcher')) {
                return;
            }
            
            isDragging = true;
            dragStartX = e.clientX;
            dragStartY = e.clientY;
            
            const rect = floatingToolbar.getBoundingClientRect();
            toolbarStartX = rect.left;
            toolbarStartY = rect.top;
            
            // Remove position classes while dragging
            floatingToolbar.classList.remove('position-top', 'position-left', 'position-right', 'position-bottom');
            
            // Set inline styles for dragging
            floatingToolbar.style.position = 'fixed';
            floatingToolbar.style.left = toolbarStartX + 'px';
            floatingToolbar.style.top = toolbarStartY + 'px';
            floatingToolbar.style.transform = 'none';
            floatingToolbar.style.right = 'auto';
            floatingToolbar.style.bottom = 'auto';
            
            e.preventDefault();
        });
        
        // Throttle function for performance
        function throttle(func, limit) {
            let inThrottle;
            return function() {
                const args = arguments;
                const context = this;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            }
        }
        
        // Mouse move - drag (with throttling)
        const handleMouseMove = throttle((e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - dragStartX;
            const deltaY = e.clientY - dragStartY;
            
            const newX = toolbarStartX + deltaX;
            const newY = toolbarStartY + deltaY;
            
            floatingToolbar.style.left = newX + 'px';
            floatingToolbar.style.top = newY + 'px';
        }, 16); // ~60fps
        
        document.addEventListener('mousemove', handleMouseMove);
        
        // Mouse up - stop dragging and snap
        document.addEventListener('mouseup', (e) => {
            if (!isDragging) return;
            
            isDragging = false;
            
            const rect = floatingToolbar.getBoundingClientRect();
            const snapPosition = calculateSnapPosition(rect.left, rect.top);
            
            // Clear inline styles
            floatingToolbar.style.position = '';
            floatingToolbar.style.left = '';
            floatingToolbar.style.top = '';
            floatingToolbar.style.transform = '';
            floatingToolbar.style.right = '';
            floatingToolbar.style.bottom = '';
            
            // Apply snap position
            setToolbarPosition(snapPosition);
        });
        
        // Restore position when toolbar is shown
        function restoreToolbarPosition() {
            const savedPosition = getToolbarPosition();
            setToolbarPosition(savedPosition);
        }
        
        // Override the show floating toolbar function to restore position
        const originalShowFloatingToolbar = () => {
            const floatingToolbar = document.getElementById('floating-preview-toolbar');
            if (floatingToolbar) {
                floatingToolbar.style.display = 'flex';
                restoreToolbarPosition();
            }
        };
        
        // Update the existing preview button click handler to restore toolbar position
        const existingPreviewBtn = document.getElementById('btn-preview');
        if (existingPreviewBtn) {
            // Override the existing click handler to include position restoration
            const originalHandler = existingPreviewBtn.onclick;
            existingPreviewBtn.addEventListener('click', function() {
                // Call the original handler first
                if (originalHandler) originalHandler.call(this);
                
                // If entering preview mode, restore toolbar position
                if (this.classList.contains('active')) {
                    setTimeout(() => {
                        restoreToolbarPosition();
                    }, 100);
                }
            });
        }
        
    </script>
</body>
</html>
