(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();class u{constructor(){this.baseURL=window.location.hostname==="localhost"?"http://localhost:5000":"https://api.pagemade.site",this.accessToken=null,this.refreshToken=null}setupTokenRefresh(){}async request(e,o={}){const t=`${this.baseURL}${e}`,r=localStorage.getItem("access_token"),s={headers:{"Content-Type":"application/json",...o.headers},credentials:"include",...o};r&&(s.headers.Authorization=`Bearer ${r}`);try{const n=await fetch(t,s),a=await n.json();if(n.status===401){const i=`Authentication failed (401) - ${a.error||"Token invalid or expired"}`;throw console.error("ðŸš« API Error:",i),console.error("ðŸš« URL:",t),console.error("ðŸš« Response:",a),new Error(i)}if(!n.ok){const i=a.error||`HTTP error! status: ${n.status}`;throw console.error("ðŸš« API Error:",i),console.error("ðŸš« URL:",t),console.error("ðŸš« Response:",a),new Error(i)}return a}catch(n){throw console.error("âŒ API request failed:",n),console.error("âŒ Endpoint:",e),n}}async refreshAccessToken(){return!1}async login(e,o){try{const r=await(await fetch(`${this.baseURL}/api/auth/login`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({email:e.toLowerCase().trim(),password:o})})).json();if(r.success)return localStorage.setItem("user",JSON.stringify(r.data.user)),r.data;throw new Error(r.message||"Login failed")}catch(t){throw console.error("Login failed:",t),t}}async logout(){try{await this.request("/api/auth/logout",{method:"POST"})}catch(e){console.error("Logout API call failed:",e)}finally{localStorage.removeItem("user"),window.location.href="http://localhost:3000/login"}}async getCurrentUser(){try{const e=await this.request("/api/auth/me");return e.success?e.data.user:null}catch(e){return console.error("Get current user failed:",e),null}}getStoredUser(){try{const e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){return console.error("Failed to parse stored user:",e),null}}isAuthenticated(){return!!this.getStoredUser()}async getPages(e){try{const o=await this.request(`/api/sites/${e}/pages`);return o.success?o.data.pages:[]}catch(o){return console.error("Get pages failed:",o),[]}}async getPage(e){try{const o=await this.request(`/api/pages/${e}/content`);return o.success?o.data:null}catch(o){return console.error("Get page failed:",o),null}}async savePage(e,o){try{return(await this.request(`/api/pages/${e}`,{method:"PUT",body:JSON.stringify(o)})).success}catch(t){return console.error("Save page failed:",t),!1}}async savePageMadeContent(e,o){try{console.log("ðŸ”Œ [API] savePageMadeContent called for page:",e),console.log("ðŸ”Œ [API] Token exists:",!!localStorage.getItem("access_token"));const t=await this.request(`/api/pages/${e}/pagemade/save`,{method:"POST",body:JSON.stringify(o)});return console.log("ðŸ”Œ [API] Response:",t),t.success}catch(t){return console.error("ðŸ”Œ [API] Save PageMade content failed:",t),!1}}async getSites(){try{const e=await this.request("/api/sites");return e.success?e.data.sites:[]}catch(e){return console.error("Get sites failed:",e),[]}}async uploadAsset(e,o){try{const t=new FormData;t.append("file",e),t.append("site_id",o);const s=await(await fetch(`${this.baseURL}/api/assets/upload`,{method:"POST",credentials:"include",body:t})).json();return s.success?s.data.asset:null}catch(t){return console.error("Upload asset failed:",t),null}}async getAssets(e){try{const o=await this.request(`/api/sites/${e}/assets`);return o.success?o.data.assets:[]}catch(o){return console.error("Get assets failed:",o),[]}}async publishPage(e,o){try{const t=await this.request(`/api/pages/${e}/publish`,{method:"POST",body:JSON.stringify(o)});return t.success?t.data:null}catch(t){throw console.error("Publish page failed:",t),t}}async verifyEditorToken(e){try{const o=await this.request(`/api/editor/verify-token/${e}`);return o.success?o.data:null}catch(o){throw console.error("Token verification failed:",o),o}}}window.apiClient=new u;console.log("âœ… API Client initialized and attached to window.apiClient");class l{constructor(){this.accessToken=localStorage.getItem("access_token"),this.refreshToken=localStorage.getItem("refresh_token"),this.user=JSON.parse(localStorage.getItem("user")||"null")}isAuthenticated(){return this.accessToken?(console.log("ðŸ”‘ Access token found, authentication likely valid"),!0):this.getStoredUser()?(console.log("ðŸ‘¤ Stored user found, authentication likely valid"),!0):(console.log("âŒ No authentication found (no token, no stored user)"),!1)}getStoredUser(){try{const e=localStorage.getItem("user");return e?JSON.parse(e):null}catch(e){return console.error("Failed to parse stored user:",e),null}}getCurrentUser(){return this.getStoredUser()}redirectToLogin(e=null){const o=e||window.location.href,t=`http://localhost:5000/login?next=${encodeURIComponent(o)}`;console.log("ðŸ” Redirecting to backend login:",t),window.location.href=t}redirectToWebsite(){console.log("ðŸ  Redirecting to dashboard"),window.location.href="http://localhost:5000/dashboard"}async checkAuth(){console.log("ðŸ” Starting authentication check...");const e=new URLSearchParams(window.location.search),o=e.get("token");if(o){console.log("ðŸ”‘ [PRIORITY] Found token in URL, processing immediately..."),localStorage.setItem("access_token",o),this.accessToken=o,e.delete("token");const t=window.location.pathname+(e.toString()?"?"+e.toString():"");return window.history.replaceState({},document.title,t),console.log("âœ… [PRIORITY] URL token saved to localStorage and URL cleaned"),console.log("âœ… [PRIORITY] Treating as authenticated - skipping backend verification for now"),!0}console.log("ðŸ” No URL token found, verifying stored authentication with backend...");try{const t={"Content-Type":"application/json"};this.accessToken&&(t.Authorization=`Bearer ${this.accessToken}`,console.log("ðŸ”‘ Using token-based authentication"));const r=await fetch("http://localhost:5000/api/auth/me",{method:"GET",credentials:"include",headers:t});if(!r.ok)throw r.status===401?(console.log("âŒ Authentication failed (401) - stored token is invalid"),this.clearTokens(),new Error("Authentication failed: Token invalid or expired (401)")):new Error(`Authentication check failed: ${r.status}`);const s=await r.json();return console.log("âœ… Authentication verified:",s.user),s.user&&(localStorage.setItem("user",JSON.stringify(s.user)),this.user=s.user),!0}catch(t){if(console.error("âŒ Authentication verification failed:",t),console.error("âŒ Error details:",t.message),this.clearTokens(),!new URLSearchParams(window.location.search).get("token")&&!this.accessToken)return console.log("ðŸ” No token found anywhere, redirecting to login is appropriate"),this.redirectToLogin(),!1;throw new Error(`Authentication verification failed: ${t.message}`)}}clearTokens(){localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("user"),this.accessToken=null,this.refreshToken=null,this.user=null,console.log("ðŸ—‘ï¸ Authentication tokens cleared")}handleAuthError(e){return e.status===401||e.message==="Token expired"||e.status===401?(console.log("ðŸ” Authentication expired, redirecting to website login"),this.clearTokens(),this.redirectToLogin(),!0):!1}getAuthHeader(){return this.accessToken?`Bearer ${this.accessToken}`:null}setupTokenRefresh(){setInterval(async()=>{if(this.accessToken)try{const o=JSON.parse(atob(this.accessToken.split(".")[1])).exp*1e3,t=Date.now();o-t<5*60*1e3&&await this.refreshToken()}catch(e){console.error("Token refresh check failed:",e)}},6e4)}async refreshToken(){return console.log("ðŸ”„ Token refresh not needed with shared cookies"),!0}}window.authGuard=new l;window.authGuard=new l;async function d(){console.log("ðŸš€ Starting editor initialization...");const e=new URLSearchParams(window.location.search).get("token");if(e){console.log("ðŸ”‘ URL token found! Saving to localStorage before authentication check..."),localStorage.setItem("access_token",e),window.authGuard.accessToken=e,console.log("âœ… URL token saved, proceeding with editor load");const r=document.createElement("script");r.type="module",r.src="./scripts/main.js",document.head.appendChild(r);return}if(console.log("ðŸ” No URL token, checking stored authentication..."),!window.authGuard.isAuthenticated()){console.log("ðŸ” No stored authentication found, redirecting to login..."),window.authGuard.redirectToLogin();return}if(console.log("âœ… Stored authentication found, verifying with backend..."),!await window.authGuard.checkAuth()){console.log("âŒ Backend authentication verification failed");return}console.log("âœ… Authentication verified, loading editor...");const t=document.createElement("script");t.type="module",t.src="./scripts/main.js",document.head.appendChild(t)}d();
